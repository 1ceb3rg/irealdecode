"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.decodeIrealPlaylist = exports.decodeIreal = exports.detectPlaylist = exports.encodeIreal = exports.transposeIrealString = void 0;
const fixedEncodeURIComponent = (string) => {
    return encodeURIComponent(string).replace(/[!'()*]/g, (c) => {
        return "%" + c.charCodeAt(0).toString(16);
    });
};
// Regex to to check for ireal song
const SongUrlRegex = /^irealb\w*:\/\/[^=]*=[^=]*==[^=]*=[^=]*=([^=]*)?[^=]*=[^=]*=[^=]*=[^=]*=[^=]*$/;
// Keys with their transposition number for IReal
const MajorKeys = {
    C: 0,
    Db: 1,
    D: 2,
    Eb: 3,
    E: 4,
    F: 5,
    Gb: 6,
    G: 7,
    Ab: 8,
    A: 9,
    Bb: 10,
    B: 11,
};
Object.freeze(MajorKeys);
const MinorKeys = {
    "A-": 0,
    "Bb-": 1,
    "B-": 2,
    "C-": 3,
    "C#-": 4,
    "D-": 5,
    "Eb-": 6,
    "E-": 7,
    "F-": 8,
    "F#-": 9,
    "G-": 10,
    "G#-": 11,
};
Object.freeze(MinorKeys);
const Keys = Object.assign(Object.assign({}, MajorKeys), MinorKeys);
Object.freeze(Keys);
// Transpose an encoded iRealString. Only works with the irealb:// links (new format)
function transposeIrealString(irealLink, transpose) {
    if (!SongUrlRegex.test(irealLink))
        return undefined;
    return (/irealbook/.test(irealLink)
        ? encodeIreal(decodeIreal(irealLink))
        : irealLink).replace(/(?<=irealb\w*:\/\/[^=]*=[^=]*==[^=]*=[^=]*=)([^=]*)?(?=[^=]*=[^=]*=[^=]*=[^=]*=[^=]*)/, Keys[transpose].toString());
}
exports.transposeIrealString = transposeIrealString;
//encode an ireal URL from an IReal object
function encodeIreal(ireal) {
    var _a, _b, _c;
    if (ireal === null || ireal === void 0 ? void 0 : ireal.oldForm)
        return `irealbook://${ireal.title}=${ireal.artist}=${ireal.style}=${ireal.key}=n=${ireal.changes}`;
    return `irealb://${fixedEncodeURIComponent(ireal.title)}=${fixedEncodeURIComponent(ireal.artist)}==${fixedEncodeURIComponent(ireal.style)}=${fixedEncodeURIComponent(ireal.key)}=${ireal.transpose}=${encodeURIComponent("1r34LbKcu7" + ireal.changes)}=${encodeURIComponent((_a = ireal === null || ireal === void 0 ? void 0 : ireal.playbackStyle) !== null && _a !== void 0 ? _a : "")}=${+((_b = ireal === null || ireal === void 0 ? void 0 : ireal.tempo) !== null && _b !== void 0 ? _b : 0)}=${+((_c = ireal === null || ireal === void 0 ? void 0 : ireal.playbackNumTimes) !== null && _c !== void 0 ? _c : 3)}
`;
}
exports.encodeIreal = encodeIreal;
// convert a song string into and IReal object
function makeIreal(irealString, isOldForm) {
    const data = irealString.split("=");
    return isOldForm
        ? {
            title: data[0].trim(),
            artist: data[1].trim(),
            style: data[3].trim(),
            key: data[4].trim(),
            changes: data[5],
            oldForm: true
        }
        : {
            title: data[0].trim(),
            artist: data[1].trim(),
            style: data[3].trim(),
            key: data[4].trim(),
            transpose: data[5],
            changes: data[6].split("1r34LbKcu7")[1],
            playbackStyle: data[7].trim() || "",
            tempo: data[8] || "0",
            playbackNumTimes: data[9] || "3",
        };
}
// Detect if an item is a playlist
function detectPlaylist(link) {
    const playlist = /(?<=ireal(b|book):\/\/([^=]*=[^=]*==[^=]*=[^=]*=([^=]*)?[^=]*=[^=]*=[^=]*=[^=]*=[^=]*===)*)[^=]*$/.exec(decodeURIComponent(link));
    return playlist ? playlist[0] : undefined;
}
exports.detectPlaylist = detectPlaylist;
// return an IReal object if the link is a single song, or undefined if it's not
function decodeIreal(link) {
    const isOldForm = /irealbook/.test(link);
    if (!SongUrlRegex.test(link) && !isOldForm)
        return undefined;
    const decoded = decodeURIComponent(link);
    return makeIreal(decoded.replace(/irealb\w*:\/\//, ""), isOldForm);
}
exports.decodeIreal = decodeIreal;
function decodeIrealPlaylist(link) {
    return new Promise((resolve, reject) => {
        var _a;
        //check for the old format
        const isOldForm = /irealbook/.test(link);
        const playlist = detectPlaylist(link);
        // decode the URL format and remove the link prefix
        const decoded = decodeURIComponent(link.replace(/irealb\w*:\/\//, ""));
        // check if it's a playlist
        if (playlist) {
            const data = /(.*)===([^=]*)$/.exec(decoded);
            if (data) {
                const result = {
                    title: playlist,
                    songs: (_a = data[1]
                        .split("===")) === null || _a === void 0 ? void 0 : _a.map((song) => makeIreal(song, isOldForm)),
                };
                result.songs.every(song => song !== undefined) ? resolve(result) : reject('Cannot parse playlist');
            }
            else
                reject("Cannot parse playlist");
        }
        else
            reject("Is not a playlist");
    });
}
exports.decodeIrealPlaylist = decodeIrealPlaylist;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLE1BQU0sdUJBQXVCLEdBQUcsQ0FBQyxNQUFjLEVBQVUsRUFBRTtJQUN6RCxPQUFPLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtRQUMxRCxPQUFPLEdBQUcsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1QyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQUVGLG1DQUFtQztBQUNuQyxNQUFNLFlBQVksR0FBRSxnRkFBZ0YsQ0FBQTtBQUVwRyxpREFBaUQ7QUFDakQsTUFBTSxTQUFTLEdBQTZCO0lBQzFDLENBQUMsRUFBRSxDQUFDO0lBQ0osRUFBRSxFQUFFLENBQUM7SUFDTCxDQUFDLEVBQUUsQ0FBQztJQUNKLEVBQUUsRUFBRSxDQUFDO0lBQ0wsQ0FBQyxFQUFFLENBQUM7SUFDSixDQUFDLEVBQUUsQ0FBQztJQUNKLEVBQUUsRUFBRSxDQUFDO0lBQ0wsQ0FBQyxFQUFFLENBQUM7SUFDSixFQUFFLEVBQUUsQ0FBQztJQUNMLENBQUMsRUFBRSxDQUFDO0lBQ0osRUFBRSxFQUFFLEVBQUU7SUFDTixDQUFDLEVBQUUsRUFBRTtDQUNOLENBQUM7QUFDRixNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3pCLE1BQU0sU0FBUyxHQUE2QjtJQUMxQyxJQUFJLEVBQUUsQ0FBQztJQUNQLEtBQUssRUFBRSxDQUFDO0lBQ1IsSUFBSSxFQUFFLENBQUM7SUFDUCxJQUFJLEVBQUUsQ0FBQztJQUNQLEtBQUssRUFBRSxDQUFDO0lBQ1IsSUFBSSxFQUFFLENBQUM7SUFDUCxLQUFLLEVBQUUsQ0FBQztJQUNSLElBQUksRUFBRSxDQUFDO0lBQ1AsSUFB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IHsgcmVzb3VyY2VMaW1pdHMgfSBmcm9tIFwid29ya2VyX3RocmVhZHNcIjtcbmltcG9ydCB7IElSZWFsLCBJUmVhbFBsYXlsaXN0LCBLZXksIE1ham9yS2V5LCBNaW5vcktleSwgUGxheWJhY2tOdW1UaW1lcywgVGVtcG8sIFRyYW5zcG9zaXRpb24gfSBmcm9tIFwiLi90eXBlc1wiO1xuY29uc3QgZml4ZWRFbmNvZGVVUklDb21wb25lbnQgPSAoc3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZykucmVwbGFjZSgvWyEnKCkqXS9nLCAoYykgPT4ge1xuICAgIHJldHVybiBcIiVcIiArIGMuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNik7XG4gIH0pO1xufTtcblxuLy8gUmVnZXggdG8gdG8gY2hlY2sgZm9yIGlyZWFsIHNvbmdcbmNvbnN0IFNvbmdVcmxSZWdleD0gL15pcmVhbGJcXHcqOlxcL1xcL1tePV0qPVtePV0qPT1bXj1dKj1bXj1dKj0oW149XSopP1tePV0qPVtePV0qPVtePV0qPVtePV0qPVtePV0qJC9cblxuLy8gS2V5cyB3aXRoIHRoZWlyIHRyYW5zcG9zaXRpb24gbnVtYmVyIGZvciBJUmVhbFxuY29uc3QgTWFqb3JLZXlzOiBSZWNvcmQ8TWFqb3JLZXksIG51bWJlcj4gPSB7XG4gIEM6IDAsXG4gIERiOiAxLFxuICBEOiAyLFxuICBFYjogMyxcbiAgRTogNCxcbiAgRjogNSxcbiAgR2I6IDYsXG4gIEc6IDcsXG4gIEFiOiA4LFxuICBBOiA5LFxuICBCYjogMTAsXG4gIEI6IDExLFxufTtcbk9iamVjdC5mcmVlemUoTWFqb3JLZXlzKTtcbmNvbnN0IE1pbm9yS2V5czogUmVjb3JkPE1pbm9yS2V5LCBudW1iZXI+ID0ge1xuICBcIkEtXCI6IDAsXG4gIFwiQmItXCI6IDEsXG4gIFwiQi1cIjogMixcbiAgXCJDLVwiOiAzLFxuICBcIkMjLVwiOiA0LFxuICBcIkQtXCI6IDUsXG4gIFwiRWItXCI6IDYsXG4gIFwiRS1cIjogNyxcbiAgXCJGLVwiOiA4LFxuICBcIkYjLVwiOiA5LFxuICBcIkctXCI6IDEwLFxuICBcIkcjLVwiOiAxMSxcbn07XG5PYmplY3QuZnJlZXplKE1pbm9yS2V5cyk7XG5cbmNvbnN0IEtleXMgPSB7IC4uLk1ham9yS2V5cywgLi4uTWlub3JLZXlzIH07XG5PYmplY3QuZnJlZXplKEtleXMpO1xuXG4vLyBUcmFuc3Bvc2UgYW4gZW5jb2RlZCBpUmVhbFN0cmluZy4gT25seSB3b3JrcyB3aXRoIHRoZSBpcmVhbGI6Ly8gbGlua3MgKG5ldyBmb3JtYXQpXG5leHBvcnQgZnVuY3Rpb24gdHJhbnNwb3NlSXJlYWxTdHJpbmcoXG4gIGlyZWFsTGluazogc3RyaW5nLFxuICB0cmFuc3Bvc2U6IE1ham9yS2V5IHwgTWlub3JLZXlcbikge1xuICBpZiAoIVNvbmdVcmxSZWdleC50ZXN0KGlyZWFsTGluaykpIHJldHVybiB1bmRlZmluZWQ7XG4gIHJldHVybiAoXG4gICAgL2lyZWFsYm9vay8udGVzdChpcmVhbExpbmspXG4gICAgICA/IGVuY29kZUlyZWFsKGRlY29kZUlyZWFsKGlyZWFsTGluaykhKVxuICAgICAgOiBpcmVhbExpbmtcbiAgKS5yZXBsYWNlKFxuICAgIC8oPzw9aXJlYWxiXFx3KjpcXC9cXC9bXj1dKj1bXj1dKj09W149XSo9W149XSo9KShbXj1dKik/KD89W149XSo9W149XSo9W149XSo9W149XSo9W149XSopLyxcbiAgICBLZXlzW3RyYW5zcG9zZV0udG9TdHJpbmcoKVxuICApO1xufVxuLy9lbmNvZGUgYW4gaXJlYWwgVVJMIGZyb20gYW4gSVJlYWwgb2JqZWN0XG5leHBvcnQgZnVuY3Rpb24gZW5jb2RlSXJlYWwoaXJlYWw6IElSZWFsKTogc3RyaW5nICB7XG4gIGlmKGlyZWFsPy5vbGRGb3JtKXJldHVybiBgaXJlYWxib29rOi8vJHtpcmVhbC50aXRsZX09JHtpcmVhbC5hcnRpc3R9PSR7aXJlYWwuc3R5bGV9PSR7aXJlYWwua2V5fT1uPSR7aXJlYWwuY2hhbmdlc31gXG4gIHJldHVybiBgaXJlYWxiOi8vJHtmaXhlZEVuY29kZVVSSUNvbXBvbmVudChcbiAgICBpcmVhbC50aXRsZVxuICApfT0ke2ZpeGVkRW5jb2RlVVJJQ29tcG9uZW50KGlyZWFsLmFydGlzdCl9PT0ke2ZpeGVkRW5jb2RlVVJJQ29tcG9uZW50KFxuICAgIGlyZWFsLnN0eWxlXG4gICl9PSR7Zml4ZWRFbmNvZGVVUklDb21wb25lbnQoaXJlYWwua2V5KX09JHtcbiAgICBpcmVhbC50cmFuc3Bvc2VcbiAgfT0ke2VuY29kZVVSSUNvbXBvbmVudChcIjFyMzRMYktjdTdcIiArIGlyZWFsLmNoYW5nZXMpfT0ke2VuY29kZVVSSUNvbXBvbmVudChcbiAgICBpcmVhbD8ucGxheWJhY2tTdHlsZSA/PyBcIlwiXG4gICl9PSR7KyhpcmVhbD8udGVtcG8gPz8gMCl9PSR7KyhpcmVhbD8ucGxheWJhY2tOdW1UaW1lcyA/PyAzKX1cbmA7XG59XG4vLyBjb252ZXJ0IGEgc29uZyBzdHJpbmcgaW50byBhbmQgSVJlYWwgb2JqZWN0XG5mdW5jdGlvbiBtYWtlSXJlYWwoaXJlYWxTdHJpbmc6IHN0cmluZywgaXNPbGRGb3JtPzogYm9vbGVhbikge1xuICBjb25zdCBkYXRhID0gaXJlYWxTdHJpbmcuc3BsaXQoXCI9XCIpO1xuICByZXR1cm4gaXNPbGRGb3JtXG4gICAgPyB7XG4gICAgICAgIHRpdGxlOiBkYXRhWzBdLnRyaW0oKSxcbiAgICAgICAgYXJ0aXN0OiBkYXRhWzFdLnRyaW0oKSxcbiAgICAgICAgc3R5bGU6IGRhdGFbM10udHJpbSgpLFxuICAgICAgICBrZXk6IGRhdGFbNF0udHJpbSgpIGFzIEtleSxcbiAgICAgICAgY2hhbmdlczogZGF0YVs1XSxcbiAgICAgICAgb2xkRm9ybTp0cnVlXG4gICAgICB9XG4gICAgOiB7XG4gICAgICAgIHRpdGxlOiBkYXRhWzBdLnRyaW0oKSxcbiAgICAgICAgYXJ0aXN0OiBkYXRhWzFdLnRyaW0oKSxcbiAgICAgICAgc3R5bGU6IGRhdGFbM10udHJpbSgpLFxuICAgICAgICBrZXk6IGRhdGFbNF0udHJpbSgpIGFzIEtleSxcbiAgICAgICAgdHJhbnNwb3NlOiBkYXRhWzVdIGFzIFRyYW5zcG9zaXRpb24sXG4gICAgICAgIGNoYW5nZXM6IGRhdGFbNl0uc3BsaXQoXCIxcjM0TGJLY3U3XCIpWzFdLFxuICAgICAgICBwbGF5YmFja1N0eWxlOiBkYXRhWzddLnRyaW0oKSB8fCBcIlwiLFxuICAgICAgICB0ZW1wbzogZGF0YVs4XSBhcyBUZW1wbyB8fCBcIjBcIiAsXG4gICAgICAgIHBsYXliYWNrTnVtVGltZXM6IGRhdGFbOV0gYXMgUGxheWJhY2tOdW1UaW1lcyB8fCBcIjNcIixcbiAgICAgIH07XG59XG4vLyBEZXRlY3QgaWYgYW4gaXRlbSBpcyBhIHBsYXlsaXN0XG5leHBvcnQgZnVuY3Rpb24gZGV0ZWN0UGxheWxpc3QobGluazogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgcGxheWxpc3QgPSAvKD88PWlyZWFsKGJ8Ym9vayk6XFwvXFwvKFtePV0qPVtePV0qPT1bXj1dKj1bXj1dKj0oW149XSopP1tePV0qPVtePV0qPVtePV0qPVtePV0qPVtePV0qPT09KSopW149XSokLy5leGVjKGRlY29kZVVSSUNvbXBvbmVudChsaW5rKSk7XG4gIFxuICByZXR1cm4gcGxheWxpc3QgPyBwbGF5bGlzdFswXSA6IHVuZGVmaW5lZDtcbn1cblxuLy8gcmV0dXJuIGFuIElSZWFsIG9iamVjdCBpZiB0aGUgbGluayBpcyBhIHNpbmdsZSBzb25nLCBvciB1bmRlZmluZWQgaWYgaXQncyBub3RcbmV4cG9ydCBmdW5jdGlvbiBkZWNvZGVJcmVhbChsaW5rOiBzdHJpbmcpOiBJUmVhbCB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IGlzT2xkRm9ybT0vaXJlYWxib29rLy50ZXN0KGxpbmspXG4gIGlmICghU29uZ1VybFJlZ2V4LnRlc3QobGluaykmJiFpc09sZEZvcm0pIHJldHVybiB1bmRlZmluZWQ7XG4gIGNvbnN0IGRlY29kZWQgPSBkZWNvZGVVUklDb21wb25lbnQobGluayk7XG4gICAgcmV0dXJuIG1ha2VJcmVhbChcbiAgICAgIGRlY29kZWQucmVwbGFjZSgvaXJlYWxiXFx3KjpcXC9cXC8vLCBcIlwiKSxcbiAgICAgIGlzT2xkRm9ybVxuICAgICk7XG59XG5cblxuXG5leHBvcnQgZnVuY3Rpb24gZGVjb2RlSXJlYWxQbGF5bGlzdChsaW5rOiBzdHJpbmcpOiBQcm9taXNlPElSZWFsUGxheWxpc3Q+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAvL2NoZWNrIGZvciB0aGUgb2xkIGZvcm1hdFxuICAgIGNvbnN0IGlzT2xkRm9ybSA9IC9pcmVhbGJvb2svLnRlc3QobGluayk7XG4gICAgY29uc3QgcGxheWxpc3QgPSBkZXRlY3RQbGF5bGlzdChsaW5rKTtcbiAgICAvLyBkZWNvZGUgdGhlIFVSTCBmb3JtYXQgYW5kIHJlbW92ZSB0aGUgbGluayBwcmVmaXhcbiAgICBjb25zdCBkZWNvZGVkID0gZGVjb2RlVVJJQ29tcG9uZW50KGxpbmsucmVwbGFjZSgvaXJlYWxiXFx3KjpcXC9cXC8vLCBcIlwiKSk7XG4gICAgLy8gY2hlY2sgaWYgaXQncyBhIHBsYXlsaXN0XG4gICAgaWYgKHBsYXlsaXN0KSB7XG4gICAgICBjb25zdCBkYXRhID0gLyguKik9PT0oW149XSopJC8uZXhlYyhkZWNvZGVkKTtcbiAgICAgIGlmIChkYXRhKVxuICAgICAge1xuICAgICAgICBjb25zdCByZXN1bHQ9e1xuICAgICAgICAgIHRpdGxlOiBwbGF5bGlzdCxcbiAgICAgICAgICBzb25nczogZGF0YVsxXVxuICAgICAgICAgICAgLnNwbGl0KFwiPT09XCIpXG4gICAgICAgICAgICA/Lm1hcCgoc29uZyk6IElSZWFsID0+bWFrZUlyZWFsKHNvbmcsaXNPbGRGb3JtKSksXG4gICAgICAgIH07XG4gICAgICAgIHJlc3VsdC5zb25ncy5ldmVyeShzb25nPT5zb25nIT09dW5kZWZpbmVkKT9yZXNvbHZlKHJlc3VsdCk6cmVqZWN0KCdDYW5ub3QgcGFyc2UgcGxheWxpc3QnKVxuICAgICAgfVxuICAgICAgZWxzZSByZWplY3QoXCJDYW5ub3QgcGFyc2UgcGxheWxpc3RcIik7XG4gICAgfSBlbHNlIHJlamVjdChcIklzIG5vdCBhIHBsYXlsaXN0XCIpO1xuICB9KTtcbn1cbiJdfQ==