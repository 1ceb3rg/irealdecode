"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.decodeIrealPlaylist = exports.decodeIreal = exports.detectPlaylist = exports.encodeIreal = exports.transposeIrealString = void 0;
const fixedEncodeURIComponent = (string) => {
    return encodeURIComponent(string).replace(/[!'()*]/g, (c) => {
        return "%" + c.charCodeAt(0).toString(16);
    });
};
const DecodedSongUrlRegex = /^ireal(b|book):\/\/[^=]+=[^=]+==[^=]+=[A-Z](b|\#)?-?=\d?\d?=1r34LbKcu7[^=]*=[^=]*=\d\d?\d?=\d\d?\d?/;
// Keys with their transposition number for IReal
const MajorKeys = {
    C: 0,
    Db: 1,
    D: 2,
    Eb: 3,
    E: 4,
    F: 5,
    Gb: 6,
    G: 7,
    Ab: 8,
    A: 9,
    Bb: 10,
    B: 11,
};
Object.freeze(MajorKeys);
const MinorKeys = {
    "A-": 0,
    "Bb-": 1,
    "B-": 2,
    "C-": 3,
    "C#-": 4,
    "D-": 5,
    "Eb-": 6,
    "E-": 7,
    "F-": 8,
    "F#-": 9,
    "G-": 10,
    "G#-": 11,
};
Object.freeze(MinorKeys);
const Keys = Object.assign(Object.assign({}, MajorKeys), MinorKeys);
Object.freeze(Keys);
// Transpose an encoded iRealString. Only works with the irealb:// links (new format)
function transposeIrealString(irealLink, transpose) {
    if (!DecodedSongUrlRegex.test(decodeURIComponent(irealLink)))
        return undefined;
    return (/irealbook/.test(irealLink)
        ? encodeIreal(decodeIreal(irealLink))
        : irealLink).split('=').reduce((newUrl, section, index) => newUrl + (index === 5 ? section : Keys[transpose].toString()));
}
exports.transposeIrealString = transposeIrealString;
//encode an ireal URL from an IReal object
function encodeIreal(ireal) {
    var _a, _b, _c;
    if (ireal === null || ireal === void 0 ? void 0 : ireal.oldForm)
        return `irealbook://${ireal.title}=${ireal.artist}=${ireal.style}=${ireal.key}=n=${ireal.changes}`;
    return `irealb://${fixedEncodeURIComponent(ireal.title)}=${fixedEncodeURIComponent(ireal.artist)}==${fixedEncodeURIComponent(ireal.style)}=${fixedEncodeURIComponent(ireal.key)}=${ireal.transpose}=${encodeURIComponent("1r34LbKcu7" + ireal.changes)}=${encodeURIComponent((_a = ireal === null || ireal === void 0 ? void 0 : ireal.playbackStyle) !== null && _a !== void 0 ? _a : "")}=${+((_b = ireal === null || ireal === void 0 ? void 0 : ireal.tempo) !== null && _b !== void 0 ? _b : 0)}=${+((_c = ireal === null || ireal === void 0 ? void 0 : ireal.playbackNumTimes) !== null && _c !== void 0 ? _c : 3)}
`;
}
exports.encodeIreal = encodeIreal;
// convert a song string into and IReal object
function makeIreal(irealString, isOldForm) {
    const data = irealString.split("=");
    return isOldForm
        ? {
            title: data[0].trim(),
            artist: data[1].trim(),
            style: data[3].trim(),
            key: data[4].trim(),
            changes: data[5],
            oldForm: true
        }
        : {
            title: data[0].trim(),
            artist: data[1].trim(),
            style: data[3].trim(),
            key: data[4].trim(),
            transpose: data[5],
            changes: data[6].split("1r34LbKcu7")[1],
            playbackStyle: data[7].trim() || "",
            tempo: data[8] || "0",
            playbackNumTimes: data[9] || "3",
        };
}
// Detect if an item is a playlist allow for maximum playlists length of 1400 songs
function detectPlaylist(link) {
    const playlist = /^(ireal(b|book):\/\/([^=]+=[^=]+==[^=]+=[A-Z](b|\#)?-?=\d?\d?=1r34LbKcu7[^=]*=[^=]*=\d\d?\d?=\d\d?\d?===){1,1400})([^=]*)$/.exec(decodeURIComponent(link));
    // playlist&&console.log(playlist![0])
    return playlist ? playlist[0] : undefined;
}
exports.detectPlaylist = detectPlaylist;
// return an IReal object if the link is a single song, or undefined if it's not
function decodeIreal(link) {
    const isOldForm = /^irealbook/.test(link);
    const decoded = decodeURIComponent(link);
    if (!DecodedSongUrlRegex.test(decoded) && !isOldForm)
        return undefined;
    return makeIreal(decoded.replace(/^irealb\w*:\/\//, ""), isOldForm);
}
exports.decodeIreal = decodeIreal;
function decodeIrealPlaylist(link) {
    return new Promise((resolve, reject) => {
        var _a;
        //check for the old format
        const isOldForm = /^irealbook/.test(link);
        const playlist = detectPlaylist(link);
        // decode the URL format and remove the link prefix
        const decoded = decodeURIComponent(link.replace(/^irealb\w*:\/\//, ""));
        // check if it's a playlist
        if (playlist) {
            const result = {
                title: playlist,
                songs: (_a = decoded.slice(0, decoded.lastIndexOf('==='))
                    .split("===")) === null || _a === void 0 ? void 0 : _a.map((song) => makeIreal(song, isOldForm)),
            };
            result.songs.every(song => song !== undefined) ? resolve(result) : reject('Cannot parse playlist');
        }
        else
            reject("Is not a playlist");
    });
}
exports.decodeIrealPlaylist = decodeIrealPlaylist;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLE1BQU0sdUJBQXVCLEdBQUcsQ0FBQyxNQUFjLEVBQVUsRUFBRTtJQUN6RCxPQUFPLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtRQUMxRCxPQUFPLEdBQUcsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1QyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQUNGLE1BQU0sbUJBQW1CLEdBQUMscUdBQXFHLENBQUE7QUFFL0gsaURBQWlEO0FBQ2pELE1BQU0sU0FBUyxHQUE2QjtJQUMxQyxDQUFDLEVBQUUsQ0FBQztJQUNKLEVBQUUsRUFBRSxDQUFDO0lBQ0wsQ0FBQyxFQUFFLENBQUM7SUFDSixFQUFFLEVBQUUsQ0FBQztJQUNMLENBQUMsRUFBRSxDQUFDO0lBQ0osQ0FBQyxFQUFFLENBQUM7SUFDSixFQUFFLEVBQUUsQ0FBQztJQUNMLENBQUMsRUFBRSxDQUFDO0lBQ0osRUFBRSxFQUFFLENBQUM7SUFDTCxDQUFDLEVBQUUsQ0FBQztJQUNKLEVBQUUsRUFBRSxFQUFFO0lBQ04sQ0FBQyxFQUFFLEVBQUU7Q0FDTixDQUFDO0FBQ0YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN6QixNQUFNLFNBQVMsR0FBNkI7SUFDMUMsSUFBSSxFQUFFLENBQUM7SUFDUCxLQUFLLEVBQUUsQ0FBQztJQUNSLElBQUksRUFBRSxDQUFDO0lBQ1AsSUFBSSxFQUFFLENBQUM7SUFDUCxLQUFLLEVBQUUsQ0FBQztJQUNSLElBQUksRUFBRSxDQUFDO0lBQ1AsS0FBSyxFQUFFLENBQUM7SUFDUixJQUFJLEVBQUUsQ0FBQztJQUNQLElBQUksRUFBRSxDQUFD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Q0FBQztJQUNyQyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFsQkQsa0RBa0JDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSVJlYWwsIElSZWFsUGxheWxpc3QsIEtleSwgTWFqb3JLZXksIE1pbm9yS2V5LCBQbGF5YmFja051bVRpbWVzLCBUZW1wbywgVHJhbnNwb3NpdGlvbiB9IGZyb20gXCIuL3R5cGVzXCI7XG5jb25zdCBmaXhlZEVuY29kZVVSSUNvbXBvbmVudCA9IChzdHJpbmc6IHN0cmluZyk6IHN0cmluZyA9PiB7XG4gIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5nKS5yZXBsYWNlKC9bIScoKSpdL2csIChjKSA9PiB7XG4gICAgcmV0dXJuIFwiJVwiICsgYy5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KTtcbiAgfSk7XG59O1xuY29uc3QgRGVjb2RlZFNvbmdVcmxSZWdleD0vXmlyZWFsKGJ8Ym9vayk6XFwvXFwvW149XSs9W149XSs9PVtePV0rPVtBLVpdKGJ8XFwjKT8tPz1cXGQ/XFxkPz0xcjM0TGJLY3U3W149XSo9W149XSo9XFxkXFxkP1xcZD89XFxkXFxkP1xcZD8vXG5cbi8vIEtleXMgd2l0aCB0aGVpciB0cmFuc3Bvc2l0aW9uIG51bWJlciBmb3IgSVJlYWxcbmNvbnN0IE1ham9yS2V5czogUmVjb3JkPE1ham9yS2V5LCBudW1iZXI+ID0ge1xuICBDOiAwLFxuICBEYjogMSxcbiAgRDogMixcbiAgRWI6IDMsXG4gIEU6IDQsXG4gIEY6IDUsXG4gIEdiOiA2LFxuICBHOiA3LFxuICBBYjogOCxcbiAgQTogOSxcbiAgQmI6IDEwLFxuICBCOiAxMSxcbn07XG5PYmplY3QuZnJlZXplKE1ham9yS2V5cyk7XG5jb25zdCBNaW5vcktleXM6IFJlY29yZDxNaW5vcktleSwgbnVtYmVyPiA9IHtcbiAgXCJBLVwiOiAwLFxuICBcIkJiLVwiOiAxLFxuICBcIkItXCI6IDIsXG4gIFwiQy1cIjogMyxcbiAgXCJDIy1cIjogNCxcbiAgXCJELVwiOiA1LFxuICBcIkViLVwiOiA2LFxuICBcIkUtXCI6IDcsXG4gIFwiRi1cIjogOCxcbiAgXCJGIy1cIjogOSxcbiAgXCJHLVwiOiAxMCxcbiAgXCJHIy1cIjogMTEsXG59O1xuT2JqZWN0LmZyZWV6ZShNaW5vcktleXMpO1xuXG5jb25zdCBLZXlzID0geyAuLi5NYWpvcktleXMsIC4uLk1pbm9yS2V5cyB9O1xuT2JqZWN0LmZyZWV6ZShLZXlzKTtcblxuLy8gVHJhbnNwb3NlIGFuIGVuY29kZWQgaVJlYWxTdHJpbmcuIE9ubHkgd29ya3Mgd2l0aCB0aGUgaXJlYWxiOi8vIGxpbmtzIChuZXcgZm9ybWF0KVxuZXhwb3J0IGZ1bmN0aW9uIHRyYW5zcG9zZUlyZWFsU3RyaW5nKFxuICBpcmVhbExpbms6IHN0cmluZyxcbiAgdHJhbnNwb3NlOiBNYWpvcktleSB8IE1pbm9yS2V5XG4pIHtcbiAgXG4gIGlmICghRGVjb2RlZFNvbmdVcmxSZWdleC50ZXN0KGRlY29kZVVSSUNvbXBvbmVudChpcmVhbExpbmspKSkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgXG4gIHJldHVybiAoXG4gICAgL2lyZWFsYm9vay8udGVzdChpcmVhbExpbmspXG4gICAgICA/IGVuY29kZUlyZWFsKGRlY29kZUlyZWFsKGlyZWFsTGluaykhKVxuICAgICAgOiBpcmVhbExpbmtcbiAgKS5zcGxpdCgnPScpLnJlZHVjZSgobmV3VXJsLHNlY3Rpb24saW5kZXgpPT5uZXdVcmwrKGluZGV4PT09NT9zZWN0aW9uOktleXNbdHJhbnNwb3NlXS50b1N0cmluZygpKSk7XG5cbiAgXG59XG4vL2VuY29kZSBhbiBpcmVhbCBVUkwgZnJvbSBhbiBJUmVhbCBvYmplY3RcbmV4cG9ydCBmdW5jdGlvbiBlbmNvZGVJcmVhbChpcmVhbDogSVJlYWwpOiBzdHJpbmcgIHtcbiAgaWYoaXJlYWw/Lm9sZEZvcm0pcmV0dXJuIGBpcmVhbGJvb2s6Ly8ke2lyZWFsLnRpdGxlfT0ke2lyZWFsLmFydGlzdH09JHtpcmVhbC5zdHlsZX09JHtpcmVhbC5rZXl9PW49JHtpcmVhbC5jaGFuZ2VzfWBcbiAgcmV0dXJuIGBpcmVhbGI6Ly8ke2ZpeGVkRW5jb2RlVVJJQ29tcG9uZW50KFxuICAgIGlyZWFsLnRpdGxlXG4gICl9PSR7Zml4ZWRFbmNvZGVVUklDb21wb25lbnQoaXJlYWwuYXJ0aXN0KX09PSR7Zml4ZWRFbmNvZGVVUklDb21wb25lbnQoXG4gICAgaXJlYWwuc3R5bGVcbiAgKX09JHtmaXhlZEVuY29kZVVSSUNvbXBvbmVudChpcmVhbC5rZXkpfT0ke1xuICAgIGlyZWFsLnRyYW5zcG9zZVxuICB9PSR7ZW5jb2RlVVJJQ29tcG9uZW50KFwiMXIzNExiS2N1N1wiICsgaXJlYWwuY2hhbmdlcyl9PSR7ZW5jb2RlVVJJQ29tcG9uZW50KFxuICAgIGlyZWFsPy5wbGF5YmFja1N0eWxlID8/IFwiXCJcbiAgKX09JHsrKGlyZWFsPy50ZW1wbyA/PyAwKX09JHsrKGlyZWFsPy5wbGF5YmFja051bVRpbWVzID8/IDMpfVxuYDtcbn1cbi8vIGNvbnZlcnQgYSBzb25nIHN0cmluZyBpbnRvIGFuZCBJUmVhbCBvYmplY3RcbmZ1bmN0aW9uIG1ha2VJcmVhbChpcmVhbFN0cmluZzogc3RyaW5nLCBpc09sZEZvcm0/OiBib29sZWFuKSB7XG4gIGNvbnN0IGRhdGEgPSBpcmVhbFN0cmluZy5zcGxpdChcIj1cIik7XG4gIHJldHVybiBpc09sZEZvcm1cbiAgICA/IHtcbiAgICAgICAgdGl0bGU6IGRhdGFbMF0udHJpbSgpLFxuICAgICAgICBhcnRpc3Q6IGRhdGFbMV0udHJpbSgpLFxuICAgICAgICBzdHlsZTogZGF0YVszXS50cmltKCksXG4gICAgICAgIGtleTogZGF0YVs0XS50cmltKCkgYXMgS2V5LFxuICAgICAgICBjaGFuZ2VzOiBkYXRhWzVdLFxuICAgICAgICBvbGRGb3JtOnRydWVcbiAgICAgIH1cbiAgICA6IHtcbiAgICAgICAgdGl0bGU6IGRhdGFbMF0udHJpbSgpLFxuICAgICAgICBhcnRpc3Q6IGRhdGFbMV0udHJpbSgpLFxuICAgICAgICBzdHlsZTogZGF0YVszXS50cmltKCksXG4gICAgICAgIGtleTogZGF0YVs0XS50cmltKCkgYXMgS2V5LFxuICAgICAgICB0cmFuc3Bvc2U6IGRhdGFbNV0gYXMgVHJhbnNwb3NpdGlvbixcbiAgICAgICAgY2hhbmdlczogZGF0YVs2XS5zcGxpdChcIjFyMzRMYktjdTdcIilbMV0sXG4gICAgICAgIHBsYXliYWNrU3R5bGU6IGRhdGFbN10udHJpbSgpIHx8IFwiXCIsXG4gICAgICAgIHRlbXBvOiBkYXRhWzhdIGFzIFRlbXBvIHx8IFwiMFwiICxcbiAgICAgICAgcGxheWJhY2tOdW1UaW1lczogZGF0YVs5XSBhcyBQbGF5YmFja051bVRpbWVzIHx8IFwiM1wiLFxuICAgICAgfTtcbn1cbi8vIERldGVjdCBpZiBhbiBpdGVtIGlzIGEgcGxheWxpc3QgYWxsb3cgZm9yIG1heGltdW0gcGxheWxpc3RzIGxlbmd0aCBvZiAxNDAwIHNvbmdzXG5leHBvcnQgZnVuY3Rpb24gZGV0ZWN0UGxheWxpc3QobGluazogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgcGxheWxpc3QgPSAvXihpcmVhbChifGJvb2spOlxcL1xcLyhbXj1dKz1bXj1dKz09W149XSs9W0EtWl0oYnxcXCMpPy0/PVxcZD9cXGQ/PTFyMzRMYktjdTdbXj1dKj1bXj1dKj1cXGRcXGQ/XFxkPz1cXGRcXGQ/XFxkPz09PSl7MSwxNDAwfSkoW149XSopJC8uZXhlYyhkZWNvZGVVUklDb21wb25lbnQobGluaykpO1xuICAvLyBwbGF5bGlzdCYmY29uc29sZS5sb2cocGxheWxpc3QhWzBdKVxuXG4gIHJldHVybiBwbGF5bGlzdCA/IHBsYXlsaXN0WzBdIDogdW5kZWZpbmVkO1xufVxuXG4vLyByZXR1cm4gYW4gSVJlYWwgb2JqZWN0IGlmIHRoZSBsaW5rIGlzIGEgc2luZ2xlIHNvbmcsIG9yIHVuZGVmaW5lZCBpZiBpdCdzIG5vdFxuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZUlyZWFsKGxpbms6IHN0cmluZyk6IElSZWFsIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgaXNPbGRGb3JtPS9eaXJlYWxib29rLy50ZXN0KGxpbmspXG4gIGNvbnN0IGRlY29kZWQ9ZGVjb2RlVVJJQ29tcG9uZW50KGxpbmspXG4gIGlmICghRGVjb2RlZFNvbmdVcmxSZWdleC50ZXN0KGRlY29kZWQpJiYhaXNPbGRGb3JtKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIHJldHVybiBtYWtlSXJlYWwoXG4gICAgICBkZWNvZGVkLnJlcGxhY2UoL15pcmVhbGJcXHcqOlxcL1xcLy8sIFwiXCIpLFxuICAgICAgaXNPbGRGb3JtXG4gICAgKTtcbn1cblxuXG5cbmV4cG9ydCBmdW5jdGlvbiBkZWNvZGVJcmVhbFBsYXlsaXN0KGxpbms6IHN0cmluZyk6IFByb21pc2U8SVJlYWxQbGF5bGlzdD4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIC8vY2hlY2sgZm9yIHRoZSBvbGQgZm9ybWF0XG4gICAgY29uc3QgaXNPbGRGb3JtID0gL15pcmVhbGJvb2svLnRlc3QobGluayk7XG4gICAgY29uc3QgcGxheWxpc3QgPSBkZXRlY3RQbGF5bGlzdChsaW5rKTtcbiAgICAvLyBkZWNvZGUgdGhlIFVSTCBmb3JtYXQgYW5kIHJlbW92ZSB0aGUgbGluayBwcmVmaXhcbiAgICBjb25zdCBkZWNvZGVkID0gZGVjb2RlVVJJQ29tcG9uZW50KGxpbmsucmVwbGFjZSgvXmlyZWFsYlxcdyo6XFwvXFwvLywgXCJcIikpO1xuICAgIC8vIGNoZWNrIGlmIGl0J3MgYSBwbGF5bGlzdFxuICAgIGlmIChwbGF5bGlzdCkge1xuICAgICAgICBjb25zdCByZXN1bHQ9e1xuICAgICAgICAgIHRpdGxlOiBwbGF5bGlzdCxcbiAgICAgICAgICBzb25nczogZGVjb2RlZC5zbGljZSgwLGRlY29kZWQubGFzdEluZGV4T2YoJz09PScpKVxuICAgICAgICAgICAgLnNwbGl0KFwiPT09XCIpXG4gICAgICAgICAgICA/Lm1hcCgoc29uZyk6IElSZWFsID0+bWFrZUlyZWFsKHNvbmcsaXNPbGRGb3JtKSksXG4gICAgICAgIH07XG4gICAgICAgIHJlc3VsdC5zb25ncy5ldmVyeShzb25nPT5zb25nIT09dW5kZWZpbmVkKT9yZXNvbHZlKHJlc3VsdCk6cmVqZWN0KCdDYW5ub3QgcGFyc2UgcGxheWxpc3QnKVxuICAgIH0gZWxzZSByZWplY3QoXCJJcyBub3QgYSBwbGF5bGlzdFwiKTtcbiAgfSk7XG59XG4iXX0=