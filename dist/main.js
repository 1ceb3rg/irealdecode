"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.decodeIrealPlaylist = exports.decodeIreal = exports.detectPlaylist = exports.encodeIreal = exports.transposeIrealString = void 0;
const fixedEncodeURIComponent = (string) => {
    return encodeURIComponent(string).replace(/[!'()*]/g, (c) => {
        return "%" + c.charCodeAt(0).toString(16);
    });
};
/*
'One Note Samba=Jobim Antonio-Carlos==Bossa Nova=Bb==1r34LbKcu7|QyX74D-7XX7-D|QyX11#7B|yQX7-C|QyX7bD|QyyQ|Db4TA*[yX7-DQ|B7#bA|QyX7^bE|QyXb7B|QyX7-F|QyX117XyQ|yX7-CX7^bDXyQ|CbA|QyX7-bEB*[]yQX6bBZL11#7B 7-7XyQ|7bD|QbD|Qy LZC#*[] 7F 7hC|QyX^7B|QyX7#F|QyX7-AD-7XlcKQyQyX11C-7XyyX7-C|QyX7bD|QXy7-D|QyX11#7B|QQ|B7#|QyX7|QyX7yQ|BbX7C|QyX6bD|QyXb7A|QyX7^bE|QyX7yQ|B^X7-F|Bb6XyQZ =Jazz-Bossa Nova=0=3'
 */
// Regex to to check for ireal song
const SongUrlRegex = /^ireal(b|book):\/\/[^=]*=[^=]*==[^=]*=[^=]*=([^=]*)?[^=]*=[^=]*=[^=]*=[^=]*=[^=]*$/;
const DecodedSongUrlRegex = /^ireal(b|book):\/\/[^=]*=[^=]*==[^=]*=[A-Z](b|\#)?-?=\d?\d?=1r34LbKcu7[^=]*=[^=]*=\d\d?\d?=\d\d?\d?/;
// Keys with their transposition number for IReal
const MajorKeys = {
    C: 0,
    Db: 1,
    D: 2,
    Eb: 3,
    E: 4,
    F: 5,
    Gb: 6,
    G: 7,
    Ab: 8,
    A: 9,
    Bb: 10,
    B: 11,
};
Object.freeze(MajorKeys);
const MinorKeys = {
    "A-": 0,
    "Bb-": 1,
    "B-": 2,
    "C-": 3,
    "C#-": 4,
    "D-": 5,
    "Eb-": 6,
    "E-": 7,
    "F-": 8,
    "F#-": 9,
    "G-": 10,
    "G#-": 11,
};
Object.freeze(MinorKeys);
const Keys = Object.assign(Object.assign({}, MajorKeys), MinorKeys);
Object.freeze(Keys);
// Transpose an encoded iRealString. Only works with the irealb:// links (new format)
function transposeIrealString(irealLink, transpose) {
    if (!DecodedSongUrlRegex.test(decodeURIComponent(irealLink)))
        return undefined;
    return (/irealbook/.test(irealLink)
        ? encodeIreal(decodeIreal(irealLink))
        : irealLink).replace(/(?<=irealb\w*:\/\/[^=]*=[^=]*==[^=]*=[^=]*=)([^=]*)?(?=[^=]*=[^=]*=[^=]*=[^=]*=[^=]*)/, Keys[transpose].toString());
}
exports.transposeIrealString = transposeIrealString;
//encode an ireal URL from an IReal object
function encodeIreal(ireal) {
    var _a, _b, _c;
    if (ireal === null || ireal === void 0 ? void 0 : ireal.oldForm)
        return `irealbook://${ireal.title}=${ireal.artist}=${ireal.style}=${ireal.key}=n=${ireal.changes}`;
    return `irealb://${fixedEncodeURIComponent(ireal.title)}=${fixedEncodeURIComponent(ireal.artist)}==${fixedEncodeURIComponent(ireal.style)}=${fixedEncodeURIComponent(ireal.key)}=${ireal.transpose}=${encodeURIComponent("1r34LbKcu7" + ireal.changes)}=${encodeURIComponent((_a = ireal === null || ireal === void 0 ? void 0 : ireal.playbackStyle) !== null && _a !== void 0 ? _a : "")}=${+((_b = ireal === null || ireal === void 0 ? void 0 : ireal.tempo) !== null && _b !== void 0 ? _b : 0)}=${+((_c = ireal === null || ireal === void 0 ? void 0 : ireal.playbackNumTimes) !== null && _c !== void 0 ? _c : 3)}
`;
}
exports.encodeIreal = encodeIreal;
// convert a song string into and IReal object
function makeIreal(irealString, isOldForm) {
    const data = irealString.split("=");
    return isOldForm
        ? {
            title: data[0].trim(),
            artist: data[1].trim(),
            style: data[3].trim(),
            key: data[4].trim(),
            changes: data[5],
            oldForm: true
        }
        : {
            title: data[0].trim(),
            artist: data[1].trim(),
            style: data[3].trim(),
            key: data[4].trim(),
            transpose: data[5],
            changes: data[6].split("1r34LbKcu7")[1],
            playbackStyle: data[7].trim() || "",
            tempo: data[8] || "0",
            playbackNumTimes: data[9] || "3",
        };
}
// Detect if an item is a playlist
function detectPlaylist(link) {
    const playlist = /(?<=^ireal(b|book):\/\/([^=]*=[^=]*==[^=]*=[A-Z](b|\#)?-?=\d?\d?=1r34LbKcu7[^=]*=[^=]*=\d\d?\d?=\d\d?\d?===)*)[^=]*$/.exec(decodeURIComponent(link));
    return playlist ? playlist[0] : undefined;
}
exports.detectPlaylist = detectPlaylist;
// return an IReal object if the link is a single song, or undefined if it's not
function decodeIreal(link) {
    const isOldForm = /^irealbook/.test(link);
    const decoded = decodeURIComponent(link);
    if (!DecodedSongUrlRegex.test(decoded) && !isOldForm)
        return undefined;
    return makeIreal(decoded.replace(/^irealb\w*:\/\//, ""), isOldForm);
}
exports.decodeIreal = decodeIreal;
function decodeIrealPlaylist(link) {
    return new Promise((resolve, reject) => {
        var _a;
        //check for the old format
        const isOldForm = /^irealbook/.test(link);
        const playlist = detectPlaylist(link);
        // decode the URL format and remove the link prefix
        const decoded = decodeURIComponent(link.replace(/^irealb\w*:\/\//, ""));
        // check if it's a playlist
        if (playlist) {
            const data = /(.*)===([^=]*)$/.exec(decoded);
            if (data) {
                const result = {
                    title: playlist,
                    songs: (_a = data[1]
                        .split("===")) === null || _a === void 0 ? void 0 : _a.map((song) => makeIreal(song, isOldForm)),
                };
                result.songs.every(song => song !== undefined) ? resolve(result) : reject('Cannot parse playlist');
            }
            else
                reject("Cannot parse playlist");
        }
        else
            reject("Is not a playlist");
    });
}
exports.decodeIrealPlaylist = decodeIrealPlaylist;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLE1BQU0sdUJBQXVCLEdBQUcsQ0FBQyxNQUFjLEVBQVUsRUFBRTtJQUN6RCxPQUFPLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtRQUMxRCxPQUFPLEdBQUcsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1QyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQUNGOztHQUVHO0FBQ0gsbUNBQW1DO0FBQ25DLE1BQU0sWUFBWSxHQUFRLG9GQUFvRixDQUFBO0FBQzlHLE1BQU0sbUJBQW1CLEdBQUMscUdBQXFHLENBQUE7QUFFL0gsaURBQWlEO0FBQ2pELE1BQU0sU0FBUyxHQUE2QjtJQUMxQyxDQUFDLEVBQUUsQ0FBQztJQUNKLEVBQUUsRUFBRSxDQUFDO0lBQ0wsQ0FBQyxFQUFFLENBQUM7SUFDSixFQUFFLEVBQUUsQ0FBQztJQUNMLENBQUMsRUFBRSxDQUFDO0lBQ0osQ0FBQyxFQUFFLENBQUM7SUFDSixFQUFFLEVBQUUsQ0FBQztJQUNMLENBQUMsRUFBRSxDQUFDO0lBQ0osRUFBRSxFQUFFLENBQUM7SUFDTCxDQUFDLEVBQUUsQ0FBQztJQUNKLEVBQUUsRUFBRSxFQUFFO0lBQ04sQ0FBQyxFQUFFLEVBQUU7Q0FDTixDQUFDO0FBQ0YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN6QixNQUFNLFNBQVMsR0FBNkI7SUFDMUMsSUFBSSxFQUFFLENBQUM7SUFDUCxLQUFLLEVBQUUsQ0FBQztJQUNSLElBQUksRUFBRSxDQUFDO0lBQ1AsSUFBSSxFQUFFLENBQUM7SUFDUCxLQUFLLEVBQUUsQ0FBQztJQUNSLElBQUksRUFBRSxDQUFDO0lBQ1AsS0FBSyxFQUFFLENBQUM7SUFDUixJQUFJLEVBQUUsQ0FBQztJQUNQLElBQUksRUFBRSxDQUFDO0lBQ1AsS0FBSyxFQUFFLENBQUM7SUFDUixJQUFJLEVBQUUsRUFBRTtJQUNSLEtBQUssRUFBRSxFQUFFO0NBQ1YsQ0FBQztBQUNGLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFekIsTUFBTSxJQUFJLG1DQUFRLFNBQVMsR0FBSyxTQUFTLENBQUUsQ0FBQztBQUM1QyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRXBCLHFGQUFxRjtBQUNyRixTQUFnQixvQkFBb0IsQ0FDbEMsU0FBaUIsRUFDakIsU0FBOEI7SUFFOUIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUFFLE9BQU8sU0FBUyxDQUFDO0lBQy9FLE9BQU8sQ0FDTCxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUN6QixDQUFDLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUUsQ0FBQztRQUN0QyxDQUFDLENBQUMsU0FBUyxDQUNkLENBQUMsT0FBTyxDQUNQLHVGQUF1RixFQUN2RixJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQzNCLENBQUM7QUFDSixDQUFDO0FBYkQsb0RBYUM7QUFDRCwwQ0FBMEM7QUFDMUMsU0FBZ0IsV0FBVyxDQUFDLEtBQVk7O0lBQ3RDLElBQUcsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLE9BQU87UUFBQyxPQUFPLGVBQWUsS0FBSyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLEdBQUcsTUFBTSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDcEgsT0FBTyxZQUFZLHVCQUF1QixDQUN4QyxLQUFLLENBQUMsS0FBSyxDQUNaLElBQUksdUJBQXVCLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLHVCQUF1QixDQUNwRSxLQUFLLENBQUMsS0FBSyxDQUNaLElBQUksdUJBQXVCLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUNyQyxLQUFLLENBQUMsU0FDUixJQUFJLGtCQUFrQixDQUFDLFlBQVksR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksa0JBQWtCLENBQ3hFLE1BQUEsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLGFBQWEsbUNBQUksRUFBRSxDQUMzQixJQUFJLENBQUMsQ0FBQyxNQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxLQUFLLG1DQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxnQkFBZ0IsbUNBQUksQ0FBQyxDQUFDO0NBQzdELENBQUM7QUFDRixDQUFDO0FBWkQsa0NBWUM7QUFDRCw4Q0FBOEM7QUFDOUMsU0FBUyxTQUFTLENBQUMsV0FBbUIsRUFBRSxTQUFtQjtJQUN6RCxNQUFNLElBQUksR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3BDLE9BQU8sU0FBUztRQUNkLENBQUMsQ0FBQztZQUNFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQ3JCLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQ3RCLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQ3JCLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFTO1lBQzFCLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2hCLE9BQU8sRUFBQyxJQUFJO1NBQ2I7UUFDSCxDQUFDLENBQUM7WUFDRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRTtZQUNyQixNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRTtZQUN0QixLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRTtZQUNyQixHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBUztZQUMxQixTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBa0I7WUFDbkMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRTtZQUNuQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBVSxJQUFJLEdBQUc7WUFDOUIsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBcUIsSUFBSSxHQUFHO1NBQ3JELENBQUM7QUFDUixDQUFDO0FBQ0Qsa0NBQWtDO0FBQ2xDLFNBQWdCLGNBQWMsQ0FBQyxJQUFZO0lBQ3pDLE1BQU0sUUFBUSxHQUFHLHNIQUFzSCxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBRXZLLE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUM1QyxDQUFDO0FBSkQsd0NBSUM7QUFFRCxnRkFBZ0Y7QUFDaEYsU0FBZ0IsV0FBVyxDQUFDLElBQVk7SUFDdEMsTUFBTSxTQUFTLEdBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN2QyxNQUFNLE9BQU8sR0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN0QyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFFLENBQUMsU0FBUztRQUFFLE9BQU8sU0FBUyxDQUFDO0lBQ25FLE9BQU8sU0FBUyxDQUNkLE9BQU8sQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLEVBQ3RDLFNBQVMsQ0FDVixDQUFDO0FBQ04sQ0FBQztBQVJELGtDQVFDO0FBSUQsU0FBZ0IsbUJBQW1CLENBQUMsSUFBWTtJQUM5QyxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFOztRQUNyQywwQkFBMEI7UUFDMUIsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMxQyxNQUFNLFFBQVEsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEMsbURBQW1EO1FBQ25ELE1BQU0sT0FBTyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4RSwyQkFBMkI7UUFDM0IsSUFBSSxRQUFRLEVBQUU7WUFDWixNQUFNLElBQUksR0FBRyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDN0MsSUFBSSxJQUFJLEVBQ1I7Z0JBQ0UsTUFBTSxNQUFNLEdBQUM7b0JBQ1gsS0FBSyxFQUFFLFFBQVE7b0JBQ2YsS0FBSyxFQUFFLE1BQUEsSUFBSSxDQUFDLENBQUMsQ0FBQzt5QkFDWCxLQUFLLENBQUMsS0FBSyxDQUFDLDBDQUNYLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBUyxFQUFFLENBQUEsU0FBUyxDQUFDLElBQUksRUFBQyxTQUFTLENBQUMsQ0FBQztpQkFDbkQsQ0FBQztnQkFDRixNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUEsRUFBRSxDQUFBLElBQUksS0FBRyxTQUFTLENBQUMsQ0FBQSxDQUFDLENBQUEsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBLENBQUMsQ0FBQSxNQUFNLENBQUMsdUJBQXVCLENBQUMsQ0FBQTthQUMzRjs7Z0JBQ0ksTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUM7U0FDdEM7O1lBQU0sTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7SUFDckMsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBdkJELGtEQXVCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElSZWFsLCBJUmVhbFBsYXlsaXN0LCBLZXksIE1ham9yS2V5LCBNaW5vcktleSwgUGxheWJhY2tOdW1UaW1lcywgVGVtcG8sIFRyYW5zcG9zaXRpb24gfSBmcm9tIFwiLi90eXBlc1wiO1xuY29uc3QgZml4ZWRFbmNvZGVVUklDb21wb25lbnQgPSAoc3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZykucmVwbGFjZSgvWyEnKCkqXS9nLCAoYykgPT4ge1xuICAgIHJldHVybiBcIiVcIiArIGMuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNik7XG4gIH0pO1xufTtcbi8qXG4nT25lIE5vdGUgU2FtYmE9Sm9iaW0gQW50b25pby1DYXJsb3M9PUJvc3NhIE5vdmE9QmI9PTFyMzRMYktjdTd8UXlYNzRELTdYWDctRHxReVgxMSM3Qnx5UVg3LUN8UXlYN2JEfFF5eVF8RGI0VEEqW3lYNy1EUXxCNyNiQXxReVg3XmJFfFF5WGI3QnxReVg3LUZ8UXlYMTE3WHlRfHlYNy1DWDdeYkRYeVF8Q2JBfFF5WDctYkVCKltdeVFYNmJCWkwxMSM3QiA3LTdYeVF8N2JEfFFiRHxReSBMWkMjKltdIDdGIDdoQ3xReVheN0J8UXlYNyNGfFF5WDctQUQtN1hsY0tReVF5WDExQy03WHl5WDctQ3xReVg3YkR8UVh5Ny1EfFF5WDExIzdCfFFRfEI3I3xReVg3fFF5WDd5UXxCYlg3Q3xReVg2YkR8UXlYYjdBfFF5WDdeYkV8UXlYN3lRfEJeWDctRnxCYjZYeVFaID1KYXp6LUJvc3NhIE5vdmE9MD0zJ1xuICovXG4vLyBSZWdleCB0byB0byBjaGVjayBmb3IgaXJlYWwgc29uZ1xuY29uc3QgU29uZ1VybFJlZ2V4PSAgICAgICAvXmlyZWFsKGJ8Ym9vayk6XFwvXFwvW149XSo9W149XSo9PVtePV0qPVtePV0qPShbXj1dKik/W149XSo9W149XSo9W149XSo9W149XSo9W149XSokL1xuY29uc3QgRGVjb2RlZFNvbmdVcmxSZWdleD0vXmlyZWFsKGJ8Ym9vayk6XFwvXFwvW149XSo9W149XSo9PVtePV0qPVtBLVpdKGJ8XFwjKT8tPz1cXGQ/XFxkPz0xcjM0TGJLY3U3W149XSo9W149XSo9XFxkXFxkP1xcZD89XFxkXFxkP1xcZD8vXG5cbi8vIEtleXMgd2l0aCB0aGVpciB0cmFuc3Bvc2l0aW9uIG51bWJlciBmb3IgSVJlYWxcbmNvbnN0IE1ham9yS2V5czogUmVjb3JkPE1ham9yS2V5LCBudW1iZXI+ID0ge1xuICBDOiAwLFxuICBEYjogMSxcbiAgRDogMixcbiAgRWI6IDMsXG4gIEU6IDQsXG4gIEY6IDUsXG4gIEdiOiA2LFxuICBHOiA3LFxuICBBYjogOCxcbiAgQTogOSxcbiAgQmI6IDEwLFxuICBCOiAxMSxcbn07XG5PYmplY3QuZnJlZXplKE1ham9yS2V5cyk7XG5jb25zdCBNaW5vcktleXM6IFJlY29yZDxNaW5vcktleSwgbnVtYmVyPiA9IHtcbiAgXCJBLVwiOiAwLFxuICBcIkJiLVwiOiAxLFxuICBcIkItXCI6IDIsXG4gIFwiQy1cIjogMyxcbiAgXCJDIy1cIjogNCxcbiAgXCJELVwiOiA1LFxuICBcIkViLVwiOiA2LFxuICBcIkUtXCI6IDcsXG4gIFwiRi1cIjogOCxcbiAgXCJGIy1cIjogOSxcbiAgXCJHLVwiOiAxMCxcbiAgXCJHIy1cIjogMTEsXG59O1xuT2JqZWN0LmZyZWV6ZShNaW5vcktleXMpO1xuXG5jb25zdCBLZXlzID0geyAuLi5NYWpvcktleXMsIC4uLk1pbm9yS2V5cyB9O1xuT2JqZWN0LmZyZWV6ZShLZXlzKTtcblxuLy8gVHJhbnNwb3NlIGFuIGVuY29kZWQgaVJlYWxTdHJpbmcuIE9ubHkgd29ya3Mgd2l0aCB0aGUgaXJlYWxiOi8vIGxpbmtzIChuZXcgZm9ybWF0KVxuZXhwb3J0IGZ1bmN0aW9uIHRyYW5zcG9zZUlyZWFsU3RyaW5nKFxuICBpcmVhbExpbms6IHN0cmluZyxcbiAgdHJhbnNwb3NlOiBNYWpvcktleSB8IE1pbm9yS2V5XG4pIHtcbiAgaWYgKCFEZWNvZGVkU29uZ1VybFJlZ2V4LnRlc3QoZGVjb2RlVVJJQ29tcG9uZW50KGlyZWFsTGluaykpKSByZXR1cm4gdW5kZWZpbmVkO1xuICByZXR1cm4gKFxuICAgIC9pcmVhbGJvb2svLnRlc3QoaXJlYWxMaW5rKVxuICAgICAgPyBlbmNvZGVJcmVhbChkZWNvZGVJcmVhbChpcmVhbExpbmspISlcbiAgICAgIDogaXJlYWxMaW5rXG4gICkucmVwbGFjZShcbiAgICAvKD88PWlyZWFsYlxcdyo6XFwvXFwvW149XSo9W149XSo9PVtePV0qPVtePV0qPSkoW149XSopPyg/PVtePV0qPVtePV0qPVtePV0qPVtePV0qPVtePV0qKS8sXG4gICAgS2V5c1t0cmFuc3Bvc2VdLnRvU3RyaW5nKClcbiAgKTtcbn1cbi8vZW5jb2RlIGFuIGlyZWFsIFVSTCBmcm9tIGFuIElSZWFsIG9iamVjdFxuZXhwb3J0IGZ1bmN0aW9uIGVuY29kZUlyZWFsKGlyZWFsOiBJUmVhbCk6IHN0cmluZyAge1xuICBpZihpcmVhbD8ub2xkRm9ybSlyZXR1cm4gYGlyZWFsYm9vazovLyR7aXJlYWwudGl0bGV9PSR7aXJlYWwuYXJ0aXN0fT0ke2lyZWFsLnN0eWxlfT0ke2lyZWFsLmtleX09bj0ke2lyZWFsLmNoYW5nZXN9YFxuICByZXR1cm4gYGlyZWFsYjovLyR7Zml4ZWRFbmNvZGVVUklDb21wb25lbnQoXG4gICAgaXJlYWwudGl0bGVcbiAgKX09JHtmaXhlZEVuY29kZVVSSUNvbXBvbmVudChpcmVhbC5hcnRpc3QpfT09JHtmaXhlZEVuY29kZVVSSUNvbXBvbmVudChcbiAgICBpcmVhbC5zdHlsZVxuICApfT0ke2ZpeGVkRW5jb2RlVVJJQ29tcG9uZW50KGlyZWFsLmtleSl9PSR7XG4gICAgaXJlYWwudHJhbnNwb3NlXG4gIH09JHtlbmNvZGVVUklDb21wb25lbnQoXCIxcjM0TGJLY3U3XCIgKyBpcmVhbC5jaGFuZ2VzKX09JHtlbmNvZGVVUklDb21wb25lbnQoXG4gICAgaXJlYWw/LnBsYXliYWNrU3R5bGUgPz8gXCJcIlxuICApfT0keysoaXJlYWw/LnRlbXBvID8/IDApfT0keysoaXJlYWw/LnBsYXliYWNrTnVtVGltZXMgPz8gMyl9XG5gO1xufVxuLy8gY29udmVydCBhIHNvbmcgc3RyaW5nIGludG8gYW5kIElSZWFsIG9iamVjdFxuZnVuY3Rpb24gbWFrZUlyZWFsKGlyZWFsU3RyaW5nOiBzdHJpbmcsIGlzT2xkRm9ybT86IGJvb2xlYW4pIHtcbiAgY29uc3QgZGF0YSA9IGlyZWFsU3RyaW5nLnNwbGl0KFwiPVwiKTtcbiAgcmV0dXJuIGlzT2xkRm9ybVxuICAgID8ge1xuICAgICAgICB0aXRsZTogZGF0YVswXS50cmltKCksXG4gICAgICAgIGFydGlzdDogZGF0YVsxXS50cmltKCksXG4gICAgICAgIHN0eWxlOiBkYXRhWzNdLnRyaW0oKSxcbiAgICAgICAga2V5OiBkYXRhWzRdLnRyaW0oKSBhcyBLZXksXG4gICAgICAgIGNoYW5nZXM6IGRhdGFbNV0sXG4gICAgICAgIG9sZEZvcm06dHJ1ZVxuICAgICAgfVxuICAgIDoge1xuICAgICAgICB0aXRsZTogZGF0YVswXS50cmltKCksXG4gICAgICAgIGFydGlzdDogZGF0YVsxXS50cmltKCksXG4gICAgICAgIHN0eWxlOiBkYXRhWzNdLnRyaW0oKSxcbiAgICAgICAga2V5OiBkYXRhWzRdLnRyaW0oKSBhcyBLZXksXG4gICAgICAgIHRyYW5zcG9zZTogZGF0YVs1XSBhcyBUcmFuc3Bvc2l0aW9uLFxuICAgICAgICBjaGFuZ2VzOiBkYXRhWzZdLnNwbGl0KFwiMXIzNExiS2N1N1wiKVsxXSxcbiAgICAgICAgcGxheWJhY2tTdHlsZTogZGF0YVs3XS50cmltKCkgfHwgXCJcIixcbiAgICAgICAgdGVtcG86IGRhdGFbOF0gYXMgVGVtcG8gfHwgXCIwXCIgLFxuICAgICAgICBwbGF5YmFja051bVRpbWVzOiBkYXRhWzldIGFzIFBsYXliYWNrTnVtVGltZXMgfHwgXCIzXCIsXG4gICAgICB9O1xufVxuLy8gRGV0ZWN0IGlmIGFuIGl0ZW0gaXMgYSBwbGF5bGlzdFxuZXhwb3J0IGZ1bmN0aW9uIGRldGVjdFBsYXlsaXN0KGxpbms6IHN0cmluZyk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IHBsYXlsaXN0ID0gLyg/PD1eaXJlYWwoYnxib29rKTpcXC9cXC8oW149XSo9W149XSo9PVtePV0qPVtBLVpdKGJ8XFwjKT8tPz1cXGQ/XFxkPz0xcjM0TGJLY3U3W149XSo9W149XSo9XFxkXFxkP1xcZD89XFxkXFxkP1xcZD89PT0pKilbXj1dKiQvLmV4ZWMoZGVjb2RlVVJJQ29tcG9uZW50KGxpbmspKTtcbiAgXG4gIHJldHVybiBwbGF5bGlzdCA/IHBsYXlsaXN0WzBdIDogdW5kZWZpbmVkO1xufVxuXG4vLyByZXR1cm4gYW4gSVJlYWwgb2JqZWN0IGlmIHRoZSBsaW5rIGlzIGEgc2luZ2xlIHNvbmcsIG9yIHVuZGVmaW5lZCBpZiBpdCdzIG5vdFxuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZUlyZWFsKGxpbms6IHN0cmluZyk6IElSZWFsIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgaXNPbGRGb3JtPS9eaXJlYWxib29rLy50ZXN0KGxpbmspXG4gIGNvbnN0IGRlY29kZWQ9ZGVjb2RlVVJJQ29tcG9uZW50KGxpbmspXG4gIGlmICghRGVjb2RlZFNvbmdVcmxSZWdleC50ZXN0KGRlY29kZWQpJiYhaXNPbGRGb3JtKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIHJldHVybiBtYWtlSXJlYWwoXG4gICAgICBkZWNvZGVkLnJlcGxhY2UoL15pcmVhbGJcXHcqOlxcL1xcLy8sIFwiXCIpLFxuICAgICAgaXNPbGRGb3JtXG4gICAgKTtcbn1cblxuXG5cbmV4cG9ydCBmdW5jdGlvbiBkZWNvZGVJcmVhbFBsYXlsaXN0KGxpbms6IHN0cmluZyk6IFByb21pc2U8SVJlYWxQbGF5bGlzdD4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIC8vY2hlY2sgZm9yIHRoZSBvbGQgZm9ybWF0XG4gICAgY29uc3QgaXNPbGRGb3JtID0gL15pcmVhbGJvb2svLnRlc3QobGluayk7XG4gICAgY29uc3QgcGxheWxpc3QgPSBkZXRlY3RQbGF5bGlzdChsaW5rKTtcbiAgICAvLyBkZWNvZGUgdGhlIFVSTCBmb3JtYXQgYW5kIHJlbW92ZSB0aGUgbGluayBwcmVmaXhcbiAgICBjb25zdCBkZWNvZGVkID0gZGVjb2RlVVJJQ29tcG9uZW50KGxpbmsucmVwbGFjZSgvXmlyZWFsYlxcdyo6XFwvXFwvLywgXCJcIikpO1xuICAgIC8vIGNoZWNrIGlmIGl0J3MgYSBwbGF5bGlzdFxuICAgIGlmIChwbGF5bGlzdCkge1xuICAgICAgY29uc3QgZGF0YSA9IC8oLiopPT09KFtePV0qKSQvLmV4ZWMoZGVjb2RlZCk7XG4gICAgICBpZiAoZGF0YSlcbiAgICAgIHtcbiAgICAgICAgY29uc3QgcmVzdWx0PXtcbiAgICAgICAgICB0aXRsZTogcGxheWxpc3QsXG4gICAgICAgICAgc29uZ3M6IGRhdGFbMV1cbiAgICAgICAgICAgIC5zcGxpdChcIj09PVwiKVxuICAgICAgICAgICAgPy5tYXAoKHNvbmcpOiBJUmVhbCA9Pm1ha2VJcmVhbChzb25nLGlzT2xkRm9ybSkpLFxuICAgICAgICB9O1xuICAgICAgICByZXN1bHQuc29uZ3MuZXZlcnkoc29uZz0+c29uZyE9PXVuZGVmaW5lZCk/cmVzb2x2ZShyZXN1bHQpOnJlamVjdCgnQ2Fubm90IHBhcnNlIHBsYXlsaXN0JylcbiAgICAgIH1cbiAgICAgIGVsc2UgcmVqZWN0KFwiQ2Fubm90IHBhcnNlIHBsYXlsaXN0XCIpO1xuICAgIH0gZWxzZSByZWplY3QoXCJJcyBub3QgYSBwbGF5bGlzdFwiKTtcbiAgfSk7XG59XG4iXX0=