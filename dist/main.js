"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.decodeIrealPlaylist = exports.decodeIreal = exports.detectPlaylist = exports.encodeIreal = exports.transposeIrealString = void 0;
const fixedEncodeURIComponent = (string) => {
    return encodeURIComponent(string).replace(/[!'()*]/g, (c) => {
        return "%" + c.charCodeAt(0).toString(16);
    });
};
const DecodedSongUrlRegex = /^ireal(b|book):\/\/[^=]+=[^=]+==[^=]+=[A-Z](b|\#)?-?=\d?\d?=1r34LbKcu7[^=]*=[^=]*=\d\d?\d?=\d\d?\d?/;
// Keys with their transposition number for IReal
const MajorKeys = {
    C: 0,
    Db: 1,
    D: 2,
    Eb: 3,
    E: 4,
    F: 5,
    Gb: 6,
    G: 7,
    Ab: 8,
    A: 9,
    Bb: 10,
    B: 11,
};
Object.freeze(MajorKeys);
const MinorKeys = {
    "A-": 0,
    "Bb-": 1,
    "B-": 2,
    "C-": 3,
    "C#-": 4,
    "D-": 5,
    "Eb-": 6,
    "E-": 7,
    "F-": 8,
    "F#-": 9,
    "G-": 10,
    "G#-": 11,
};
Object.freeze(MinorKeys);
const Keys = Object.assign(Object.assign({}, MajorKeys), MinorKeys);
Object.freeze(Keys);
// Transpose an encoded iRealString. Only works with the irealb:// links (new format)
function transposeIrealString(irealLink, transpose) {
    if (!DecodedSongUrlRegex.test(decodeURIComponent(irealLink)))
        return undefined;
    return (/irealbook/.test(irealLink)
        ? encodeIreal(decodeIreal(irealLink))
        : irealLink)
        .split("=")
        .map((section, index) => index !== 5 ? section : Keys[transpose].toString())
        .join("=");
}
exports.transposeIrealString = transposeIrealString;
//encode an ireal URL from an IReal object
function encodeIreal(ireal) {
    var _a, _b, _c;
    if (ireal === null || ireal === void 0 ? void 0 : ireal.oldForm)
        return `irealbook://${ireal.title}=${ireal.artist}=${ireal.style}=${ireal.key}=n=${ireal.changes}`;
    return `irealb://${fixedEncodeURIComponent(ireal.title)}=${fixedEncodeURIComponent(ireal.artist)}==${fixedEncodeURIComponent(ireal.style)}=${fixedEncodeURIComponent(ireal.key)}=${ireal.transpose}=${encodeURIComponent("1r34LbKcu7" + ireal.changes)}=${encodeURIComponent((_a = ireal === null || ireal === void 0 ? void 0 : ireal.playbackStyle) !== null && _a !== void 0 ? _a : "")}=${+((_b = ireal === null || ireal === void 0 ? void 0 : ireal.tempo) !== null && _b !== void 0 ? _b : 0)}=${+((_c = ireal === null || ireal === void 0 ? void 0 : ireal.playbackNumTimes) !== null && _c !== void 0 ? _c : 3)}
`;
}
exports.encodeIreal = encodeIreal;
// convert a song string into and IReal object
function makeIreal(irealString, isOldForm) {
    const data = irealString.split("=");
    return isOldForm
        ? {
            title: data[0].trim(),
            artist: data[1].trim(),
            style: data[3].trim(),
            key: data[4].trim(),
            changes: data[5],
            oldForm: true,
        }
        : {
            title: data[0].trim(),
            artist: data[1].trim(),
            style: data[3].trim(),
            key: data[4].trim(),
            transpose: data[5],
            changes: data[6].split("1r34LbKcu7")[1],
            playbackStyle: data[7].trim() || "",
            tempo: data[8] || "0",
            playbackNumTimes: data[9] || "3",
        };
}
// Detect if an item is a playlist allow for maximum playlists length of 1400 songs
function detectPlaylist(link) {
    const playlist = /^(ireal(b|book):\/\/([^=]+=[^=]+==[^=]+=[A-Z](b|\#)?-?=\d?\d?=1r34LbKcu7[^=]*=[^=]*=\d\d?\d?=\d\d?\d?===){1,1400})([^=]*)$/.exec(decodeURIComponent(link));
    return playlist ? playlist[5] : undefined;
}
exports.detectPlaylist = detectPlaylist;
// return an IReal object if the link is a single song, or undefined if it's not
function decodeIreal(link) {
    const isOldForm = /^irealbook/.test(link);
    const decoded = decodeURIComponent(link);
    if (!DecodedSongUrlRegex.test(decoded) && !isOldForm)
        return undefined;
    return makeIreal(decoded.replace(/^irealb\w*:\/\//, ""), isOldForm);
}
exports.decodeIreal = decodeIreal;
function decodeIrealPlaylist(link) {
    return new Promise((resolve, reject) => {
        var _a;
        //check for the old format
        const isOldForm = /^irealbook/.test(link);
        const playlist = detectPlaylist(link);
        // decode the URL format and remove the link prefix
        const decoded = decodeURIComponent(link.replace(/^irealb\w*:\/\//, ""));
        // check if it's a playlist
        if (playlist) {
            const result = {
                title: playlist,
                songs: (_a = decoded
                    .slice(0, decoded.lastIndexOf("==="))
                    .split("===")) === null || _a === void 0 ? void 0 : _a.map((song) => makeIreal(song, isOldForm)),
            };
            result.songs.every((song) => song !== undefined)
                ? resolve(result)
                : reject("Cannot parse playlist");
        }
        else
            reject("Is not a playlist");
    });
}
exports.decodeIrealPlaylist = decodeIrealPlaylist;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQVVBLE1BQU0sdUJBQXVCLEdBQUcsQ0FBQyxNQUFjLEVBQVUsRUFBRTtJQUN6RCxPQUFPLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtRQUMxRCxPQUFPLEdBQUcsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1QyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQUNGLE1BQU0sbUJBQW1CLEdBQ3ZCLHFHQUFxRyxDQUFDO0FBRXhHLGlEQUFpRDtBQUNqRCxNQUFNLFNBQVMsR0FBNkI7SUFDMUMsQ0FBQyxFQUFFLENBQUM7SUFDSixFQUFFLEVBQUUsQ0FBQztJQUNMLENBQUMsRUFBRSxDQUFDO0lBQ0osRUFBRSxFQUFFLENBQUM7SUFDTCxDQUFDLEVBQUUsQ0FBQztJQUNKLENBQUMsRUFBRSxDQUFDO0lBQ0osRUFBRSxFQUFFLENBQUM7SUFDTCxDQUFDLEVBQUUsQ0FBQztJQUNKLEVBQUUsRUFBRSxDQUFDO0lBQ0wsQ0FBQyxFQUFFLENBQUM7SUFDSixFQUFFLEVBQUUsRUFBRTtJQUNOLENBQUMsRUFBRSxFQUFFO0NBQ04sQ0FBQztBQUNGLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDekIsTUFBTSxTQUFTLEdBQTZCO0lBQzFDLElBQUksRUFBRSxDQUFDO0lBQ1AsS0FBSyxFQUFFLENBQUM7SUFDUixJQUFJLEVBQUUsQ0FBQztJQUNQLElBQUksRUFBRSxDQUFDO0lBQ1AsS0FBSyxFQUFFLENBQUM7SUFDUixJQUFJLEVBQUUsQ0FBQztJQUNQLEtBQUssRUFBRSxDQUFDO0lBQ1IsSUFBSSxFQUFFLENBQUM7SUFDUCxJQUFJLEVBQUUsQ0FBQztJQUNQLEtBQUssRUFBRSxDQUFDO0lBQ1IsSUFBSSxFQUFFLEVBQUU7SUFDUixLQUFLLEVBQUUsRUFBRTtDQUNWLENBQUM7QUFDRixNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRXpCLE1BQU0sSUFBSSxtQ0FBUSxTQUFTLEdBQUssU0FBUyxDQUFFLENBQUM7QUFDNUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUVwQixxRkFBcUY7QUFDckYsU0FBZ0Isb0JBQW9CLENBQ2xDLFNBQWlCLEVBQ2pCLFNBQThCO0lBRTlCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDMUQsT0FBTyxTQUFTLENBQUM7SUFFbkIsT0FBTyxDQUNMLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBRSxDQUFDO1FBQ3RDLENBQUMsQ0FBQyxTQUFTLENBQ2Q7U0FDRSxLQUFLLENBQUMsR0FBRyxDQUFDO1NBQ1YsR0FBRyxDQUFDLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQ3RCLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUNuRDtTQUNBLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNmLENBQUM7QUFqQkQsb0RBaUJDO0FBQ0QsMENBQTBDO0FBQzFDLFNBQWdCLFdBQVcsQ0FBQyxLQUFZOztJQUN0QyxJQUFJLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxPQUFPO1FBQ2hCLE9BQU8sZUFBZSxLQUFLLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsR0FBRyxNQUFNLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNyRyxPQUFPLFlBQVksdUJBQXVCLENBQ3hDLEtBQUssQ0FBQyxLQUFLLENBQ1osSUFBSSx1QkFBdUIsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssdUJBQXVCLENBQ3BFLEtBQUssQ0FBQyxLQUFLLENBQ1osSUFBSSx1QkFBdUIsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQ3JDLEtBQUssQ0FBQyxTQUNSLElBQUksa0JBQWtCLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxrQkFBa0IsQ0FDeEUsTUFBQSxLQUFLLGFBQUwsS0FBSyx1QkFBTCxLQUFLLENBQUUsYUFBYSxtQ0FBSSxFQUFFLENBQzNCLElBQUksQ0FBQyxDQUFDLE1BQUEsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLEtBQUssbUNBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQUEsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLGdCQUFnQixtQ0FBSSxDQUFDLENBQUM7Q0FDN0QsQ0FBQztBQUNGLENBQUM7QUFiRCxrQ0FhQztBQUNELDhDQUE4QztBQUM5QyxTQUFTLFNBQVMsQ0FBQyxXQUFtQixFQUFFLFNBQW1CO0lBQ3pELE1BQU0sSUFBSSxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDcEMsT0FBTyxTQUFTO1FBQ2QsQ0FBQyxDQUFDO1lBQ0UsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUU7WUFDckIsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUU7WUFDdEIsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUU7WUFDckIsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQVM7WUFDMUIsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDaEIsT0FBTyxFQUFFLElBQUk7U0FDZDtRQUNILENBQUMsQ0FBQztZQUNFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQ3JCLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQ3RCLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQ3JCLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFTO1lBQzFCLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFrQjtZQUNuQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFO1lBQ25DLEtBQUssRUFBRyxJQUFJLENBQUMsQ0FBQyxDQUFXLElBQUksR0FBRztZQUNoQyxnQkFBZ0IsRUFBRyxJQUFJLENBQUMsQ0FBQyxDQUFzQixJQUFJLEdBQUc7U0FDdkQsQ0FBQztBQUNSLENBQUM7QUFDRCxtRkFBbUY7QUFDbkYsU0FBZ0IsY0FBYyxDQUFDLElBQVk7SUFDekMsTUFBTSxRQUFRLEdBQ1osNEhBQTRILENBQUMsSUFBSSxDQUMvSCxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FDekIsQ0FBQztJQUVKLE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUM1QyxDQUFDO0FBUEQsd0NBT0M7QUFFRCxnRkFBZ0Y7QUFDaEYsU0FBZ0IsV0FBVyxDQUFDLElBQVk7SUFDdEMsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMxQyxNQUFNLE9BQU8sR0FBRyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN6QyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUztRQUFFLE9BQU8sU0FBUyxDQUFDO0lBQ3ZFLE9BQU8sU0FBUyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7QUFDdEUsQ0FBQztBQUxELGtDQUtDO0FBRUQsU0FBZ0IsbUJBQW1CLENBQUMsSUFBWTtJQUM5QyxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFOztRQUNyQywwQkFBMEI7UUFDMUIsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMxQyxNQUFNLFFBQVEsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEMsbURBQW1EO1FBQ25ELE1BQU0sT0FBTyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4RSwyQkFBMkI7UUFDM0IsSUFBSSxRQUFRLEVBQUU7WUFDWixNQUFNLE1BQU0sR0FBRztnQkFDYixLQUFLLEVBQUUsUUFBUTtnQkFDZixLQUFLLEVBQUUsTUFBQSxPQUFPO3FCQUNYLEtBQUssQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztxQkFDcEMsS0FBSyxDQUFDLEtBQUssQ0FBQywwQ0FDWCxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQVMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7YUFDckQsQ0FBQztZQUNGLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDO2dCQUM5QyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztnQkFDakIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1NBQ3JDOztZQUFNLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3JDLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQXJCRCxrREFxQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJUmVhbCxcbiAgSVJlYWxQbGF5bGlzdCxcbiAgS2V5LFxuICBNYWpvcktleSxcbiAgTWlub3JLZXksXG4gIFBsYXliYWNrTnVtVGltZXMsXG4gIFRlbXBvLFxuICBUcmFuc3Bvc2l0aW9uLFxufSBmcm9tIFwiLi90eXBlc1wiO1xuY29uc3QgZml4ZWRFbmNvZGVVUklDb21wb25lbnQgPSAoc3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZykucmVwbGFjZSgvWyEnKCkqXS9nLCAoYykgPT4ge1xuICAgIHJldHVybiBcIiVcIiArIGMuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNik7XG4gIH0pO1xufTtcbmNvbnN0IERlY29kZWRTb25nVXJsUmVnZXggPVxuICAvXmlyZWFsKGJ8Ym9vayk6XFwvXFwvW149XSs9W149XSs9PVtePV0rPVtBLVpdKGJ8XFwjKT8tPz1cXGQ/XFxkPz0xcjM0TGJLY3U3W149XSo9W149XSo9XFxkXFxkP1xcZD89XFxkXFxkP1xcZD8vO1xuXG4vLyBLZXlzIHdpdGggdGhlaXIgdHJhbnNwb3NpdGlvbiBudW1iZXIgZm9yIElSZWFsXG5jb25zdCBNYWpvcktleXM6IFJlY29yZDxNYWpvcktleSwgbnVtYmVyPiA9IHtcbiAgQzogMCxcbiAgRGI6IDEsXG4gIEQ6IDIsXG4gIEViOiAzLFxuICBFOiA0LFxuICBGOiA1LFxuICBHYjogNixcbiAgRzogNyxcbiAgQWI6IDgsXG4gIEE6IDksXG4gIEJiOiAxMCxcbiAgQjogMTEsXG59O1xuT2JqZWN0LmZyZWV6ZShNYWpvcktleXMpO1xuY29uc3QgTWlub3JLZXlzOiBSZWNvcmQ8TWlub3JLZXksIG51bWJlcj4gPSB7XG4gIFwiQS1cIjogMCxcbiAgXCJCYi1cIjogMSxcbiAgXCJCLVwiOiAyLFxuICBcIkMtXCI6IDMsXG4gIFwiQyMtXCI6IDQsXG4gIFwiRC1cIjogNSxcbiAgXCJFYi1cIjogNixcbiAgXCJFLVwiOiA3LFxuICBcIkYtXCI6IDgsXG4gIFwiRiMtXCI6IDksXG4gIFwiRy1cIjogMTAsXG4gIFwiRyMtXCI6IDExLFxufTtcbk9iamVjdC5mcmVlemUoTWlub3JLZXlzKTtcblxuY29uc3QgS2V5cyA9IHsgLi4uTWFqb3JLZXlzLCAuLi5NaW5vcktleXMgfTtcbk9iamVjdC5mcmVlemUoS2V5cyk7XG5cbi8vIFRyYW5zcG9zZSBhbiBlbmNvZGVkIGlSZWFsU3RyaW5nLiBPbmx5IHdvcmtzIHdpdGggdGhlIGlyZWFsYjovLyBsaW5rcyAobmV3IGZvcm1hdClcbmV4cG9ydCBmdW5jdGlvbiB0cmFuc3Bvc2VJcmVhbFN0cmluZyhcbiAgaXJlYWxMaW5rOiBzdHJpbmcsXG4gIHRyYW5zcG9zZTogTWFqb3JLZXkgfCBNaW5vcktleVxuKSB7XG4gIGlmICghRGVjb2RlZFNvbmdVcmxSZWdleC50ZXN0KGRlY29kZVVSSUNvbXBvbmVudChpcmVhbExpbmspKSlcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuXG4gIHJldHVybiAoXG4gICAgL2lyZWFsYm9vay8udGVzdChpcmVhbExpbmspXG4gICAgICA/IGVuY29kZUlyZWFsKGRlY29kZUlyZWFsKGlyZWFsTGluaykhKVxuICAgICAgOiBpcmVhbExpbmtcbiAgKVxuICAgIC5zcGxpdChcIj1cIilcbiAgICAubWFwKChzZWN0aW9uLCBpbmRleCkgPT5cbiAgICAgIGluZGV4ICE9PSA1ID8gc2VjdGlvbiA6IEtleXNbdHJhbnNwb3NlXS50b1N0cmluZygpXG4gICAgKVxuICAgIC5qb2luKFwiPVwiKTtcbn1cbi8vZW5jb2RlIGFuIGlyZWFsIFVSTCBmcm9tIGFuIElSZWFsIG9iamVjdFxuZXhwb3J0IGZ1bmN0aW9uIGVuY29kZUlyZWFsKGlyZWFsOiBJUmVhbCk6IHN0cmluZyB7XG4gIGlmIChpcmVhbD8ub2xkRm9ybSlcbiAgICByZXR1cm4gYGlyZWFsYm9vazovLyR7aXJlYWwudGl0bGV9PSR7aXJlYWwuYXJ0aXN0fT0ke2lyZWFsLnN0eWxlfT0ke2lyZWFsLmtleX09bj0ke2lyZWFsLmNoYW5nZXN9YDtcbiAgcmV0dXJuIGBpcmVhbGI6Ly8ke2ZpeGVkRW5jb2RlVVJJQ29tcG9uZW50KFxuICAgIGlyZWFsLnRpdGxlXG4gICl9PSR7Zml4ZWRFbmNvZGVVUklDb21wb25lbnQoaXJlYWwuYXJ0aXN0KX09PSR7Zml4ZWRFbmNvZGVVUklDb21wb25lbnQoXG4gICAgaXJlYWwuc3R5bGVcbiAgKX09JHtmaXhlZEVuY29kZVVSSUNvbXBvbmVudChpcmVhbC5rZXkpfT0ke1xuICAgIGlyZWFsLnRyYW5zcG9zZVxuICB9PSR7ZW5jb2RlVVJJQ29tcG9uZW50KFwiMXIzNExiS2N1N1wiICsgaXJlYWwuY2hhbmdlcyl9PSR7ZW5jb2RlVVJJQ29tcG9uZW50KFxuICAgIGlyZWFsPy5wbGF5YmFja1N0eWxlID8/IFwiXCJcbiAgKX09JHsrKGlyZWFsPy50ZW1wbyA/PyAwKX09JHsrKGlyZWFsPy5wbGF5YmFja051bVRpbWVzID8/IDMpfVxuYDtcbn1cbi8vIGNvbnZlcnQgYSBzb25nIHN0cmluZyBpbnRvIGFuZCBJUmVhbCBvYmplY3RcbmZ1bmN0aW9uIG1ha2VJcmVhbChpcmVhbFN0cmluZzogc3RyaW5nLCBpc09sZEZvcm0/OiBib29sZWFuKSB7XG4gIGNvbnN0IGRhdGEgPSBpcmVhbFN0cmluZy5zcGxpdChcIj1cIik7XG4gIHJldHVybiBpc09sZEZvcm1cbiAgICA/IHtcbiAgICAgICAgdGl0bGU6IGRhdGFbMF0udHJpbSgpLFxuICAgICAgICBhcnRpc3Q6IGRhdGFbMV0udHJpbSgpLFxuICAgICAgICBzdHlsZTogZGF0YVszXS50cmltKCksXG4gICAgICAgIGtleTogZGF0YVs0XS50cmltKCkgYXMgS2V5LFxuICAgICAgICBjaGFuZ2VzOiBkYXRhWzVdLFxuICAgICAgICBvbGRGb3JtOiB0cnVlLFxuICAgICAgfVxuICAgIDoge1xuICAgICAgICB0aXRsZTogZGF0YVswXS50cmltKCksXG4gICAgICAgIGFydGlzdDogZGF0YVsxXS50cmltKCksXG4gICAgICAgIHN0eWxlOiBkYXRhWzNdLnRyaW0oKSxcbiAgICAgICAga2V5OiBkYXRhWzRdLnRyaW0oKSBhcyBLZXksXG4gICAgICAgIHRyYW5zcG9zZTogZGF0YVs1XSBhcyBUcmFuc3Bvc2l0aW9uLFxuICAgICAgICBjaGFuZ2VzOiBkYXRhWzZdLnNwbGl0KFwiMXIzNExiS2N1N1wiKVsxXSxcbiAgICAgICAgcGxheWJhY2tTdHlsZTogZGF0YVs3XS50cmltKCkgfHwgXCJcIixcbiAgICAgICAgdGVtcG86IChkYXRhWzhdIGFzIFRlbXBvKSB8fCBcIjBcIixcbiAgICAgICAgcGxheWJhY2tOdW1UaW1lczogKGRhdGFbOV0gYXMgUGxheWJhY2tOdW1UaW1lcykgfHwgXCIzXCIsXG4gICAgICB9O1xufVxuLy8gRGV0ZWN0IGlmIGFuIGl0ZW0gaXMgYSBwbGF5bGlzdCBhbGxvdyBmb3IgbWF4aW11bSBwbGF5bGlzdHMgbGVuZ3RoIG9mIDE0MDAgc29uZ3NcbmV4cG9ydCBmdW5jdGlvbiBkZXRlY3RQbGF5bGlzdChsaW5rOiBzdHJpbmcpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICBjb25zdCBwbGF5bGlzdCA9XG4gICAgL14oaXJlYWwoYnxib29rKTpcXC9cXC8oW149XSs9W149XSs9PVtePV0rPVtBLVpdKGJ8XFwjKT8tPz1cXGQ/XFxkPz0xcjM0TGJLY3U3W149XSo9W149XSo9XFxkXFxkP1xcZD89XFxkXFxkP1xcZD89PT0pezEsMTQwMH0pKFtePV0qKSQvLmV4ZWMoXG4gICAgICBkZWNvZGVVUklDb21wb25lbnQobGluaylcbiAgICApO1xuXG4gIHJldHVybiBwbGF5bGlzdCA/IHBsYXlsaXN0WzVdIDogdW5kZWZpbmVkO1xufVxuXG4vLyByZXR1cm4gYW4gSVJlYWwgb2JqZWN0IGlmIHRoZSBsaW5rIGlzIGEgc2luZ2xlIHNvbmcsIG9yIHVuZGVmaW5lZCBpZiBpdCdzIG5vdFxuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZUlyZWFsKGxpbms6IHN0cmluZyk6IElSZWFsIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgaXNPbGRGb3JtID0gL15pcmVhbGJvb2svLnRlc3QobGluayk7XG4gIGNvbnN0IGRlY29kZWQgPSBkZWNvZGVVUklDb21wb25lbnQobGluayk7XG4gIGlmICghRGVjb2RlZFNvbmdVcmxSZWdleC50ZXN0KGRlY29kZWQpICYmICFpc09sZEZvcm0pIHJldHVybiB1bmRlZmluZWQ7XG4gIHJldHVybiBtYWtlSXJlYWwoZGVjb2RlZC5yZXBsYWNlKC9eaXJlYWxiXFx3KjpcXC9cXC8vLCBcIlwiKSwgaXNPbGRGb3JtKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZUlyZWFsUGxheWxpc3QobGluazogc3RyaW5nKTogUHJvbWlzZTxJUmVhbFBsYXlsaXN0PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgLy9jaGVjayBmb3IgdGhlIG9sZCBmb3JtYXRcbiAgICBjb25zdCBpc09sZEZvcm0gPSAvXmlyZWFsYm9vay8udGVzdChsaW5rKTtcbiAgICBjb25zdCBwbGF5bGlzdCA9IGRldGVjdFBsYXlsaXN0KGxpbmspO1xuICAgIC8vIGRlY29kZSB0aGUgVVJMIGZvcm1hdCBhbmQgcmVtb3ZlIHRoZSBsaW5rIHByZWZpeFxuICAgIGNvbnN0IGRlY29kZWQgPSBkZWNvZGVVUklDb21wb25lbnQobGluay5yZXBsYWNlKC9eaXJlYWxiXFx3KjpcXC9cXC8vLCBcIlwiKSk7XG4gICAgLy8gY2hlY2sgaWYgaXQncyBhIHBsYXlsaXN0XG4gICAgaWYgKHBsYXlsaXN0KSB7XG4gICAgICBjb25zdCByZXN1bHQgPSB7XG4gICAgICAgIHRpdGxlOiBwbGF5bGlzdCxcbiAgICAgICAgc29uZ3M6IGRlY29kZWRcbiAgICAgICAgICAuc2xpY2UoMCwgZGVjb2RlZC5sYXN0SW5kZXhPZihcIj09PVwiKSlcbiAgICAgICAgICAuc3BsaXQoXCI9PT1cIilcbiAgICAgICAgICA/Lm1hcCgoc29uZyk6IElSZWFsID0+IG1ha2VJcmVhbChzb25nLCBpc09sZEZvcm0pKSxcbiAgICAgIH07XG4gICAgICByZXN1bHQuc29uZ3MuZXZlcnkoKHNvbmcpID0+IHNvbmcgIT09IHVuZGVmaW5lZClcbiAgICAgICAgPyByZXNvbHZlKHJlc3VsdClcbiAgICAgICAgOiByZWplY3QoXCJDYW5ub3QgcGFyc2UgcGxheWxpc3RcIik7XG4gICAgfSBlbHNlIHJlamVjdChcIklzIG5vdCBhIHBsYXlsaXN0XCIpO1xuICB9KTtcbn1cbiJdfQ==