"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.decodeIrealPlaylist = exports.decodeIreal = exports.detectPlaylist = exports.encodeIreal = exports.transposeIrealString = void 0;
const fixedEncodeURIComponent = (string) => {
    return encodeURIComponent(string).replace(/[!'()*]/g, (c) => {
        return "%" + c.charCodeAt(0).toString(16);
    });
};
const DecodedSongUrlRegex = /^ireal(b|book):\/\/[^=]+=[^=]+==[^=]+=[A-Z](b|\#)?-?=\d?\d?=1r34LbKcu7[^=]*=[^=]*=\d\d?\d?=\d\d?\d?/;
// Keys with their transposition number for IReal
const MajorKeys = {
    C: 0,
    Db: 1,
    D: 2,
    Eb: 3,
    E: 4,
    F: 5,
    Gb: 6,
    G: 7,
    Ab: 8,
    A: 9,
    Bb: 10,
    B: 11,
};
Object.freeze(MajorKeys);
const MinorKeys = {
    "A-": 0,
    "Bb-": 1,
    "B-": 2,
    "C-": 3,
    "C#-": 4,
    "D-": 5,
    "Eb-": 6,
    "E-": 7,
    "F-": 8,
    "F#-": 9,
    "G-": 10,
    "G#-": 11,
};
Object.freeze(MinorKeys);
const Keys = Object.assign(Object.assign({}, MajorKeys), MinorKeys);
Object.freeze(Keys);
// Transpose an encoded iRealString. Only works with the irealb:// links (new format)
function transposeIrealString(irealLink, transpose) {
    if (!DecodedSongUrlRegex.test(decodeURIComponent(irealLink)))
        return undefined;
    return (/irealbook/.test(irealLink)
        ? encodeIreal(decodeIreal(irealLink))
        : irealLink).split('=').map((section, index) => index !== 5 ? section : Keys[transpose].toString()).join('=');
}
exports.transposeIrealString = transposeIrealString;
//encode an ireal URL from an IReal object
function encodeIreal(ireal) {
    var _a, _b, _c;
    if (ireal === null || ireal === void 0 ? void 0 : ireal.oldForm)
        return `irealbook://${ireal.title}=${ireal.artist}=${ireal.style}=${ireal.key}=n=${ireal.changes}`;
    return `irealb://${fixedEncodeURIComponent(ireal.title)}=${fixedEncodeURIComponent(ireal.artist)}==${fixedEncodeURIComponent(ireal.style)}=${fixedEncodeURIComponent(ireal.key)}=${ireal.transpose}=${encodeURIComponent("1r34LbKcu7" + ireal.changes)}=${encodeURIComponent((_a = ireal === null || ireal === void 0 ? void 0 : ireal.playbackStyle) !== null && _a !== void 0 ? _a : "")}=${+((_b = ireal === null || ireal === void 0 ? void 0 : ireal.tempo) !== null && _b !== void 0 ? _b : 0)}=${+((_c = ireal === null || ireal === void 0 ? void 0 : ireal.playbackNumTimes) !== null && _c !== void 0 ? _c : 3)}
`;
}
exports.encodeIreal = encodeIreal;
// convert a song string into and IReal object
function makeIreal(irealString, isOldForm) {
    const data = irealString.split("=");
    return isOldForm
        ? {
            title: data[0].trim(),
            artist: data[1].trim(),
            style: data[3].trim(),
            key: data[4].trim(),
            changes: data[5],
            oldForm: true
        }
        : {
            title: data[0].trim(),
            artist: data[1].trim(),
            style: data[3].trim(),
            key: data[4].trim(),
            transpose: data[5],
            changes: data[6].split("1r34LbKcu7")[1],
            playbackStyle: data[7].trim() || "",
            tempo: data[8] || "0",
            playbackNumTimes: data[9] || "3",
        };
}
// Detect if an item is a playlist allow for maximum playlists length of 1400 songs
function detectPlaylist(link) {
    const playlist = /^(ireal(b|book):\/\/([^=]+=[^=]+==[^=]+=[A-Z](b|\#)?-?=\d?\d?=1r34LbKcu7[^=]*=[^=]*=\d\d?\d?=\d\d?\d?===){1,1400})([^=]*)$/.exec(decodeURIComponent(link));
    // playlist&&console.log(playlist![0])
    return playlist ? playlist[0] : undefined;
}
exports.detectPlaylist = detectPlaylist;
// return an IReal object if the link is a single song, or undefined if it's not
function decodeIreal(link) {
    const isOldForm = /^irealbook/.test(link);
    const decoded = decodeURIComponent(link);
    if (!DecodedSongUrlRegex.test(decoded) && !isOldForm)
        return undefined;
    return makeIreal(decoded.replace(/^irealb\w*:\/\//, ""), isOldForm);
}
exports.decodeIreal = decodeIreal;
function decodeIrealPlaylist(link) {
    return new Promise((resolve, reject) => {
        var _a;
        //check for the old format
        const isOldForm = /^irealbook/.test(link);
        const playlist = detectPlaylist(link);
        // decode the URL format and remove the link prefix
        const decoded = decodeURIComponent(link.replace(/^irealb\w*:\/\//, ""));
        // check if it's a playlist
        if (playlist) {
            const result = {
                title: playlist,
                songs: (_a = decoded.slice(0, decoded.lastIndexOf('==='))
                    .split("===")) === null || _a === void 0 ? void 0 : _a.map((song) => makeIreal(song, isOldForm)),
            };
            result.songs.every(song => song !== undefined) ? resolve(result) : reject('Cannot parse playlist');
        }
        else
            reject("Is not a playlist");
    });
}
exports.decodeIrealPlaylist = decodeIrealPlaylist;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLE1BQU0sdUJBQXVCLEdBQUcsQ0FBQyxNQUFjLEVBQVUsRUFBRTtJQUN6RCxPQUFPLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtRQUMxRCxPQUFPLEdBQUcsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1QyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQUNGLE1BQU0sbUJBQW1CLEdBQUMscUdBQXFHLENBQUE7QUFFL0gsaURBQWlEO0FBQ2pELE1BQU0sU0FBUyxHQUE2QjtJQUMxQyxDQUFDLEVBQUUsQ0FBQztJQUNKLEVBQUUsRUFBRSxDQUFDO0lBQ0wsQ0FBQyxFQUFFLENBQUM7SUFDSixFQUFFLEVBQUUsQ0FBQztJQUNMLENBQUMsRUFBRSxDQUFDO0lBQ0osQ0FBQyxFQUFFLENBQUM7SUFDSixFQUFFLEVBQUUsQ0FBQztJQUNMLENBQUMsRUFBRSxDQUFDO0lBQ0osRUFBRSxFQUFFLENBQUM7SUFDTCxDQUFDLEVBQUUsQ0FBQztJQUNKLEVBQUUsRUFBRSxFQUFFO0lBQ04sQ0FBQyxFQUFFLEVBQUU7Q0FDTixDQUFDO0FBQ0YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN6QixNQUFNLFNBQVMsR0FBNkI7SUFDMUMsSUFBSSxFQUFFLENBQUM7SUFDUCxLQUFLLEVBQUUsQ0FBQztJQUNSLElBQUksRUFBRSxDQUFDO0lBQ1AsSUFBSSxFQUFFLENBQUM7SUFDUCxLQUFLLEVBQUUsQ0FBQztJQUNSLElBQUksRUFBRSxDQUFDO0lBQ1AsS0FBSyxFQUFFLENBQUM7SUFDUixJQUFJLEVBQUUsQ0FBQztJQUNQLElBQUksRUFBRSxDQUFD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SUFDckMsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBbEJELGtEQWtCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElSZWFsLCBJUmVhbFBsYXlsaXN0LCBLZXksIE1ham9yS2V5LCBNaW5vcktleSwgUGxheWJhY2tOdW1UaW1lcywgVGVtcG8sIFRyYW5zcG9zaXRpb24gfSBmcm9tIFwiLi90eXBlc1wiO1xuY29uc3QgZml4ZWRFbmNvZGVVUklDb21wb25lbnQgPSAoc3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZykucmVwbGFjZSgvWyEnKCkqXS9nLCAoYykgPT4ge1xuICAgIHJldHVybiBcIiVcIiArIGMuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNik7XG4gIH0pO1xufTtcbmNvbnN0IERlY29kZWRTb25nVXJsUmVnZXg9L15pcmVhbChifGJvb2spOlxcL1xcL1tePV0rPVtePV0rPT1bXj1dKz1bQS1aXShifFxcIyk/LT89XFxkP1xcZD89MXIzNExiS2N1N1tePV0qPVtePV0qPVxcZFxcZD9cXGQ/PVxcZFxcZD9cXGQ/L1xuXG4vLyBLZXlzIHdpdGggdGhlaXIgdHJhbnNwb3NpdGlvbiBudW1iZXIgZm9yIElSZWFsXG5jb25zdCBNYWpvcktleXM6IFJlY29yZDxNYWpvcktleSwgbnVtYmVyPiA9IHtcbiAgQzogMCxcbiAgRGI6IDEsXG4gIEQ6IDIsXG4gIEViOiAzLFxuICBFOiA0LFxuICBGOiA1LFxuICBHYjogNixcbiAgRzogNyxcbiAgQWI6IDgsXG4gIEE6IDksXG4gIEJiOiAxMCxcbiAgQjogMTEsXG59O1xuT2JqZWN0LmZyZWV6ZShNYWpvcktleXMpO1xuY29uc3QgTWlub3JLZXlzOiBSZWNvcmQ8TWlub3JLZXksIG51bWJlcj4gPSB7XG4gIFwiQS1cIjogMCxcbiAgXCJCYi1cIjogMSxcbiAgXCJCLVwiOiAyLFxuICBcIkMtXCI6IDMsXG4gIFwiQyMtXCI6IDQsXG4gIFwiRC1cIjogNSxcbiAgXCJFYi1cIjogNixcbiAgXCJFLVwiOiA3LFxuICBcIkYtXCI6IDgsXG4gIFwiRiMtXCI6IDksXG4gIFwiRy1cIjogMTAsXG4gIFwiRyMtXCI6IDExLFxufTtcbk9iamVjdC5mcmVlemUoTWlub3JLZXlzKTtcblxuY29uc3QgS2V5cyA9IHsgLi4uTWFqb3JLZXlzLCAuLi5NaW5vcktleXMgfTtcbk9iamVjdC5mcmVlemUoS2V5cyk7XG5cbi8vIFRyYW5zcG9zZSBhbiBlbmNvZGVkIGlSZWFsU3RyaW5nLiBPbmx5IHdvcmtzIHdpdGggdGhlIGlyZWFsYjovLyBsaW5rcyAobmV3IGZvcm1hdClcbmV4cG9ydCBmdW5jdGlvbiB0cmFuc3Bvc2VJcmVhbFN0cmluZyhcbiAgaXJlYWxMaW5rOiBzdHJpbmcsXG4gIHRyYW5zcG9zZTogTWFqb3JLZXkgfCBNaW5vcktleVxuKSB7XG4gIFxuICBpZiAoIURlY29kZWRTb25nVXJsUmVnZXgudGVzdChkZWNvZGVVUklDb21wb25lbnQoaXJlYWxMaW5rKSkpIHJldHVybiB1bmRlZmluZWQ7XG4gIFxuICByZXR1cm4gKFxuICAgIC9pcmVhbGJvb2svLnRlc3QoaXJlYWxMaW5rKVxuICAgICAgPyBlbmNvZGVJcmVhbChkZWNvZGVJcmVhbChpcmVhbExpbmspISlcbiAgICAgIDogaXJlYWxMaW5rXG4gICkuc3BsaXQoJz0nKS5tYXAoKHNlY3Rpb24saW5kZXgpPT5pbmRleCE9PTU/c2VjdGlvbjpLZXlzW3RyYW5zcG9zZV0udG9TdHJpbmcoKSkuam9pbignPScpO1xuXG4gIFxufVxuLy9lbmNvZGUgYW4gaXJlYWwgVVJMIGZyb20gYW4gSVJlYWwgb2JqZWN0XG5leHBvcnQgZnVuY3Rpb24gZW5jb2RlSXJlYWwoaXJlYWw6IElSZWFsKTogc3RyaW5nICB7XG4gIGlmKGlyZWFsPy5vbGRGb3JtKXJldHVybiBgaXJlYWxib29rOi8vJHtpcmVhbC50aXRsZX09JHtpcmVhbC5hcnRpc3R9PSR7aXJlYWwuc3R5bGV9PSR7aXJlYWwua2V5fT1uPSR7aXJlYWwuY2hhbmdlc31gXG4gIHJldHVybiBgaXJlYWxiOi8vJHtmaXhlZEVuY29kZVVSSUNvbXBvbmVudChcbiAgICBpcmVhbC50aXRsZVxuICApfT0ke2ZpeGVkRW5jb2RlVVJJQ29tcG9uZW50KGlyZWFsLmFydGlzdCl9PT0ke2ZpeGVkRW5jb2RlVVJJQ29tcG9uZW50KFxuICAgIGlyZWFsLnN0eWxlXG4gICl9PSR7Zml4ZWRFbmNvZGVVUklDb21wb25lbnQoaXJlYWwua2V5KX09JHtcbiAgICBpcmVhbC50cmFuc3Bvc2VcbiAgfT0ke2VuY29kZVVSSUNvbXBvbmVudChcIjFyMzRMYktjdTdcIiArIGlyZWFsLmNoYW5nZXMpfT0ke2VuY29kZVVSSUNvbXBvbmVudChcbiAgICBpcmVhbD8ucGxheWJhY2tTdHlsZSA/PyBcIlwiXG4gICl9PSR7KyhpcmVhbD8udGVtcG8gPz8gMCl9PSR7KyhpcmVhbD8ucGxheWJhY2tOdW1UaW1lcyA/PyAzKX1cbmA7XG59XG4vLyBjb252ZXJ0IGEgc29uZyBzdHJpbmcgaW50byBhbmQgSVJlYWwgb2JqZWN0XG5mdW5jdGlvbiBtYWtlSXJlYWwoaXJlYWxTdHJpbmc6IHN0cmluZywgaXNPbGRGb3JtPzogYm9vbGVhbikge1xuICBjb25zdCBkYXRhID0gaXJlYWxTdHJpbmcuc3BsaXQoXCI9XCIpO1xuICByZXR1cm4gaXNPbGRGb3JtXG4gICAgPyB7XG4gICAgICAgIHRpdGxlOiBkYXRhWzBdLnRyaW0oKSxcbiAgICAgICAgYXJ0aXN0OiBkYXRhWzFdLnRyaW0oKSxcbiAgICAgICAgc3R5bGU6IGRhdGFbM10udHJpbSgpLFxuICAgICAgICBrZXk6IGRhdGFbNF0udHJpbSgpIGFzIEtleSxcbiAgICAgICAgY2hhbmdlczogZGF0YVs1XSxcbiAgICAgICAgb2xkRm9ybTp0cnVlXG4gICAgICB9XG4gICAgOiB7XG4gICAgICAgIHRpdGxlOiBkYXRhWzBdLnRyaW0oKSxcbiAgICAgICAgYXJ0aXN0OiBkYXRhWzFdLnRyaW0oKSxcbiAgICAgICAgc3R5bGU6IGRhdGFbM10udHJpbSgpLFxuICAgICAgICBrZXk6IGRhdGFbNF0udHJpbSgpIGFzIEtleSxcbiAgICAgICAgdHJhbnNwb3NlOiBkYXRhWzVdIGFzIFRyYW5zcG9zaXRpb24sXG4gICAgICAgIGNoYW5nZXM6IGRhdGFbNl0uc3BsaXQoXCIxcjM0TGJLY3U3XCIpWzFdLFxuICAgICAgICBwbGF5YmFja1N0eWxlOiBkYXRhWzddLnRyaW0oKSB8fCBcIlwiLFxuICAgICAgICB0ZW1wbzogZGF0YVs4XSBhcyBUZW1wbyB8fCBcIjBcIiAsXG4gICAgICAgIHBsYXliYWNrTnVtVGltZXM6IGRhdGFbOV0gYXMgUGxheWJhY2tOdW1UaW1lcyB8fCBcIjNcIixcbiAgICAgIH07XG59XG4vLyBEZXRlY3QgaWYgYW4gaXRlbSBpcyBhIHBsYXlsaXN0IGFsbG93IGZvciBtYXhpbXVtIHBsYXlsaXN0cyBsZW5ndGggb2YgMTQwMCBzb25nc1xuZXhwb3J0IGZ1bmN0aW9uIGRldGVjdFBsYXlsaXN0KGxpbms6IHN0cmluZyk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IHBsYXlsaXN0ID0gL14oaXJlYWwoYnxib29rKTpcXC9cXC8oW149XSs9W149XSs9PVtePV0rPVtBLVpdKGJ8XFwjKT8tPz1cXGQ/XFxkPz0xcjM0TGJLY3U3W149XSo9W149XSo9XFxkXFxkP1xcZD89XFxkXFxkP1xcZD89PT0pezEsMTQwMH0pKFtePV0qKSQvLmV4ZWMoZGVjb2RlVVJJQ29tcG9uZW50KGxpbmspKTtcbiAgLy8gcGxheWxpc3QmJmNvbnNvbGUubG9nKHBsYXlsaXN0IVswXSlcblxuICByZXR1cm4gcGxheWxpc3QgPyBwbGF5bGlzdFswXSA6IHVuZGVmaW5lZDtcbn1cblxuLy8gcmV0dXJuIGFuIElSZWFsIG9iamVjdCBpZiB0aGUgbGluayBpcyBhIHNpbmdsZSBzb25nLCBvciB1bmRlZmluZWQgaWYgaXQncyBub3RcbmV4cG9ydCBmdW5jdGlvbiBkZWNvZGVJcmVhbChsaW5rOiBzdHJpbmcpOiBJUmVhbCB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IGlzT2xkRm9ybT0vXmlyZWFsYm9vay8udGVzdChsaW5rKVxuICBjb25zdCBkZWNvZGVkPWRlY29kZVVSSUNvbXBvbmVudChsaW5rKVxuICBpZiAoIURlY29kZWRTb25nVXJsUmVnZXgudGVzdChkZWNvZGVkKSYmIWlzT2xkRm9ybSkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICByZXR1cm4gbWFrZUlyZWFsKFxuICAgICAgZGVjb2RlZC5yZXBsYWNlKC9eaXJlYWxiXFx3KjpcXC9cXC8vLCBcIlwiKSxcbiAgICAgIGlzT2xkRm9ybVxuICAgICk7XG59XG5cblxuXG5leHBvcnQgZnVuY3Rpb24gZGVjb2RlSXJlYWxQbGF5bGlzdChsaW5rOiBzdHJpbmcpOiBQcm9taXNlPElSZWFsUGxheWxpc3Q+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAvL2NoZWNrIGZvciB0aGUgb2xkIGZvcm1hdFxuICAgIGNvbnN0IGlzT2xkRm9ybSA9IC9eaXJlYWxib29rLy50ZXN0KGxpbmspO1xuICAgIGNvbnN0IHBsYXlsaXN0ID0gZGV0ZWN0UGxheWxpc3QobGluayk7XG4gICAgLy8gZGVjb2RlIHRoZSBVUkwgZm9ybWF0IGFuZCByZW1vdmUgdGhlIGxpbmsgcHJlZml4XG4gICAgY29uc3QgZGVjb2RlZCA9IGRlY29kZVVSSUNvbXBvbmVudChsaW5rLnJlcGxhY2UoL15pcmVhbGJcXHcqOlxcL1xcLy8sIFwiXCIpKTtcbiAgICAvLyBjaGVjayBpZiBpdCdzIGEgcGxheWxpc3RcbiAgICBpZiAocGxheWxpc3QpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0PXtcbiAgICAgICAgICB0aXRsZTogcGxheWxpc3QsXG4gICAgICAgICAgc29uZ3M6IGRlY29kZWQuc2xpY2UoMCxkZWNvZGVkLmxhc3RJbmRleE9mKCc9PT0nKSlcbiAgICAgICAgICAgIC5zcGxpdChcIj09PVwiKVxuICAgICAgICAgICAgPy5tYXAoKHNvbmcpOiBJUmVhbCA9Pm1ha2VJcmVhbChzb25nLGlzT2xkRm9ybSkpLFxuICAgICAgICB9O1xuICAgICAgICByZXN1bHQuc29uZ3MuZXZlcnkoc29uZz0+c29uZyE9PXVuZGVmaW5lZCk/cmVzb2x2ZShyZXN1bHQpOnJlamVjdCgnQ2Fubm90IHBhcnNlIHBsYXlsaXN0JylcbiAgICB9IGVsc2UgcmVqZWN0KFwiSXMgbm90IGEgcGxheWxpc3RcIik7XG4gIH0pO1xufVxuIl19