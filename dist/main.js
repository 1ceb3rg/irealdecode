"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.decodeIrealPlaylist = exports.decodeIreal = exports.detectPlaylist = exports.encodeIreal = exports.transposeIrealString = void 0;
const fixedEncodeURIComponent = (string) => {
    return encodeURIComponent(string).replace(/[!'()*]/g, (c) => {
        return "%" + c.charCodeAt(0).toString(16);
    });
};
const DecodedSongUrlRegex = /^ireal(b|book):\/\/[^=]+=[^=]+==[^=]+=[A-Z](b|\#)?-?=\d?\d?=1r34LbKcu7[^=]*=[^=]*=\d\d?\d?=\d\d?\d?/;
// Keys with their transposition number for IReal
const MajorKeys = {
    C: 0,
    Db: 1,
    D: 2,
    Eb: 3,
    E: 4,
    F: 5,
    Gb: 6,
    G: 7,
    Ab: 8,
    A: 9,
    Bb: 10,
    B: 11,
};
Object.freeze(MajorKeys);
const MinorKeys = {
    "A-": 0,
    "Bb-": 1,
    "B-": 2,
    "C-": 3,
    "C#-": 4,
    "D-": 5,
    "Eb-": 6,
    "E-": 7,
    "F-": 8,
    "F#-": 9,
    "G-": 10,
    "G#-": 11,
};
Object.freeze(MinorKeys);
const Keys = Object.assign(Object.assign({}, MajorKeys), MinorKeys);
Object.freeze(Keys);
// Transpose an encoded iRealString. Only works with the irealb:// links (new format)
function transposeIrealString(irealLink, transpose) {
    if (!DecodedSongUrlRegex.test(decodeURIComponent(irealLink)))
        return undefined;
    return (/irealbook/.test(irealLink)
        ? encodeIreal(decodeIreal(irealLink))
        : irealLink).replace(/(?<=irealb\w*:\/\/[^=]*=[^=]*==[^=]*=[^=]*=)([^=]*)?(?=[^=]*=[^=]*=[^=]*=[^=]*=[^=]*)/, Keys[transpose].toString());
}
exports.transposeIrealString = transposeIrealString;
//encode an ireal URL from an IReal object
function encodeIreal(ireal) {
    var _a, _b, _c;
    if (ireal === null || ireal === void 0 ? void 0 : ireal.oldForm)
        return `irealbook://${ireal.title}=${ireal.artist}=${ireal.style}=${ireal.key}=n=${ireal.changes}`;
    return `irealb://${fixedEncodeURIComponent(ireal.title)}=${fixedEncodeURIComponent(ireal.artist)}==${fixedEncodeURIComponent(ireal.style)}=${fixedEncodeURIComponent(ireal.key)}=${ireal.transpose}=${encodeURIComponent("1r34LbKcu7" + ireal.changes)}=${encodeURIComponent((_a = ireal === null || ireal === void 0 ? void 0 : ireal.playbackStyle) !== null && _a !== void 0 ? _a : "")}=${+((_b = ireal === null || ireal === void 0 ? void 0 : ireal.tempo) !== null && _b !== void 0 ? _b : 0)}=${+((_c = ireal === null || ireal === void 0 ? void 0 : ireal.playbackNumTimes) !== null && _c !== void 0 ? _c : 3)}
`;
}
exports.encodeIreal = encodeIreal;
// convert a song string into and IReal object
function makeIreal(irealString, isOldForm) {
    const data = irealString.split("=");
    return isOldForm
        ? {
            title: data[0].trim(),
            artist: data[1].trim(),
            style: data[3].trim(),
            key: data[4].trim(),
            changes: data[5],
            oldForm: true
        }
        : {
            title: data[0].trim(),
            artist: data[1].trim(),
            style: data[3].trim(),
            key: data[4].trim(),
            transpose: data[5],
            changes: data[6].split("1r34LbKcu7")[1],
            playbackStyle: data[7].trim() || "",
            tempo: data[8] || "0",
            playbackNumTimes: data[9] || "3",
        };
}
// Detect if an item is a playlist allow for maximum playlists length of 1400 songs
function detectPlaylist(link) {
    const playlist = /(?<=^ireal(b|book):\/\/([^=]+=[^=]+==[^=]+=[A-Z](b|\#)?-?=\d?\d?=1r34LbKcu7[^=]*=[^=]*=\d\d?\d?=\d\d?\d?===){1,1400})[^=]*$/.exec(decodeURIComponent(link));
    return playlist ? playlist[0] : undefined;
}
exports.detectPlaylist = detectPlaylist;
// return an IReal object if the link is a single song, or undefined if it's not
function decodeIreal(link) {
    const isOldForm = /^irealbook/.test(link);
    const decoded = decodeURIComponent(link);
    if (!DecodedSongUrlRegex.test(decoded) && !isOldForm)
        return undefined;
    return makeIreal(decoded.replace(/^irealb\w*:\/\//, ""), isOldForm);
}
exports.decodeIreal = decodeIreal;
function decodeIrealPlaylist(link) {
    return new Promise((resolve, reject) => {
        var _a;
        //check for the old format
        const isOldForm = /^irealbook/.test(link);
        const playlist = detectPlaylist(link);
        // decode the URL format and remove the link prefix
        const decoded = decodeURIComponent(link.replace(/^irealb\w*:\/\//, ""));
        // check if it's a playlist
        if (playlist) {
            const data = /(.*)===([^=]*)$/.exec(decoded);
            if (data) {
                const result = {
                    title: playlist,
                    songs: (_a = data[1]
                        .split("===")) === null || _a === void 0 ? void 0 : _a.map((song) => makeIreal(song, isOldForm)),
                };
                result.songs.every(song => song !== undefined) ? resolve(result) : reject('Cannot parse playlist');
            }
            else
                reject("Cannot parse playlist");
        }
        else
            reject("Is not a playlist");
    });
}
exports.decodeIrealPlaylist = decodeIrealPlaylist;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLE1BQU0sdUJBQXVCLEdBQUcsQ0FBQyxNQUFjLEVBQVUsRUFBRTtJQUN6RCxPQUFPLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtRQUMxRCxPQUFPLEdBQUcsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1QyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQUNGLE1BQU0sbUJBQW1CLEdBQUMscUdBQXFHLENBQUE7QUFFL0gsaURBQWlEO0FBQ2pELE1BQU0sU0FBUyxHQUE2QjtJQUMxQyxDQUFDLEVBQUUsQ0FBQztJQUNKLEVBQUUsRUFBRSxDQUFDO0lBQ0wsQ0FBQyxFQUFFLENBQUM7SUFDSixFQUFFLEVBQUUsQ0FBQztJQUNMLENBQUMsRUFBRSxDQUFDO0lBQ0osQ0FBQyxFQUFFLENBQUM7SUFDSixFQUFFLEVBQUUsQ0FBQztJQUNMLENBQUMsRUFBRSxDQUFDO0lBQ0osRUFBRSxFQUFFLENBQUM7SUFDTCxDQUFDLEVBQUUsQ0FBQztJQUNKLEVBQUUsRUFBRSxFQUFFO0lBQ04sQ0FBQyxFQUFFLEVBQUU7Q0FDTixDQUFDO0FBQ0YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN6QixNQUFNLFNBQVMsR0FBNkI7SUFDMUMsSUFBSSxFQUFFLENBQUM7SUFDUCxLQUFLLEVBQUUsQ0FBQztJQUNSLElBQUksRUFBRSxDQUFDO0lBQ1AsSUFBSSxFQUFFLENBQUM7SUFDUCxLQUFLLEVBQUUsQ0FBQztJQUNSLElBQUksRUFBRSxDQUFDO0lBQ1AsS0FBSyxFQUFFLENBQUM7SUFDUixJQUFJLEVBQUUsQ0FBQztJQUNQLElBQUksRUFBRSxDQUFDO0lBQ1AsS0FBSyxFQUFFLENBQUM7SUFDUixJQUFJLEVBQUUsRUFBRTtJQUNSLEtBQUssRUFBRSxFQUFFO0NBQ1YsQ0FBQztBQUNGLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFekIsTUFBTSxJQUFJLG1DQUFRLFNBQVMsR0FBSyxTQUFTLENBQUUsQ0FBQztBQUM1QyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRXBCLHFGQUFxRjtBQUNyRixTQUFnQixvQkFBb0IsQ0FDbEMsU0FBaUIsRUFDakIsU0FBOEI7SUFFOUIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUFFLE9BQU8sU0FBUyxDQUFDO0lBQy9FLE9BQU8sQ0FDTCxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUN6QixDQUFDLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUUsQ0FBQztRQUN0QyxDQUFDLENBQUMsU0FBUyxDQUNkLENBQUMsT0FBTyxDQUNQLHVGQUF1RixFQUN2RixJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQzNCLENBQUM7QUFDSixDQUFDO0FBYkQsb0RBYUM7QUFDRCwwQ0FBMEM7QUFDMUMsU0FBZ0IsV0FBVyxDQUFDLEtBQVk7O0lBQ3RDLElBQUcsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLE9BQU87UUFBQyxPQUFPLGVBQWUsS0FBSyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLEdBQUcsTUFBTSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDcEgsT0FBTyxZQUFZLHVCQUF1QixDQUN4QyxLQUFLLENBQUMsS0FBSyxDQUNaLElBQUksdUJBQXVCLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLHVCQUF1QixDQUNwRSxLQUFLLENBQUMsS0FBSyxDQUNaLElBQUksdUJBQXVCLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUNyQyxLQUFLLENBQUMsU0FDUixJQUFJLGtCQUFrQixDQUFDLFlBQVksR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksa0JBQWtCLENBQ3hFLE1BQUEsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLGFBQWEsbUNBQUksRUFBRSxDQUMzQixJQUFJLENBQUMsQ0FBQyxNQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxLQUFLLG1DQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxnQkFBZ0IsbUNBQUksQ0FBQyxDQUFDO0NBQzdELENBQUM7QUFDRixDQUFDO0FBWkQsa0NBWUM7QUFDRCw4Q0FBOEM7QUFDOUMsU0FBUyxTQUFTLENBQUMsV0FBbUIsRUFBRSxTQUFtQjtJQUN6RCxNQUFNLElBQUksR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3BDLE9BQU8sU0FBUztRQUNkLENBQUMsQ0FBQztZQUNFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQ3JCLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQ3RCLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQ3JCLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFTO1lBQzFCLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2hCLE9BQU8sRUFBQyxJQUFJO1NBQ2I7UUFDSCxDQUFDLENBQUM7WUFDRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRTtZQUNyQixNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRTtZQUN0QixLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRTtZQUNyQixHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBUztZQUMxQixTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBa0I7WUFDbkMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRTtZQUNuQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBVSxJQUFJLEdBQUc7WUFDOUIsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBcUIsSUFBSSxHQUFHO1NBQ3JELENBQUM7QUFDUixDQUFDO0FBQ0QsbUZBQW1GO0FBQ25GLFNBQWdCLGNBQWMsQ0FBQyxJQUFZO0lBQ3pDLE1BQU0sUUFBUSxHQUFHLDZIQUE2SCxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBRTlLLE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUM1QyxDQUFDO0FBSkQsd0NBSUM7QUFFRCxnRkFBZ0Y7QUFDaEYsU0FBZ0IsV0FBVyxDQUFDLElBQVk7SUFDdEMsTUFBTSxTQUFTLEdBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN2QyxNQUFNLE9BQU8sR0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN0QyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFFLENBQUMsU0FBUztRQUFFLE9BQU8sU0FBUyxDQUFDO0lBQ25FLE9BQU8sU0FBUyxDQUNkLE9BQU8sQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLEVBQ3RDLFNBQVMsQ0FDVixDQUFDO0FBQ04sQ0FBQztBQVJELGtDQVFDO0FBSUQsU0FBZ0IsbUJBQW1CLENBQUMsSUFBWTtJQUM5QyxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFOztRQUNyQywwQkFBMEI7UUFDMUIsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMxQyxNQUFNLFFBQVEsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEMsbURBQW1EO1FBQ25ELE1BQU0sT0FBTyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4RSwyQkFBMkI7UUFDM0IsSUFBSSxRQUFRLEVBQUU7WUFDWixNQUFNLElBQUksR0FBRyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDN0MsSUFBSSxJQUFJLEVBQ1I7Z0JBQ0UsTUFBTSxNQUFNLEdBQUM7b0JBQ1gsS0FBSyxFQUFFLFFBQVE7b0JBQ2YsS0FBSyxFQUFFLE1BQUEsSUFBSSxDQUFDLENBQUMsQ0FBQzt5QkFDWCxLQUFLLENBQUMsS0FBSyxDQUFDLDBDQUNYLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBUyxFQUFFLENBQUEsU0FBUyxDQUFDLElBQUksRUFBQyxTQUFTLENBQUMsQ0FBQztpQkFDbkQsQ0FBQztnQkFDRixNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUEsRUFBRSxDQUFBLElBQUksS0FBRyxTQUFTLENBQUMsQ0FBQSxDQUFDLENBQUEsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBLENBQUMsQ0FBQSxNQUFNLENBQUMsdUJBQXVCLENBQUMsQ0FBQTthQUMzRjs7Z0JBQ0ksTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUM7U0FDdEM7O1lBQU0sTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7SUFDckMsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBdkJELGtEQXVCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElSZWFsLCBJUmVhbFBsYXlsaXN0LCBLZXksIE1ham9yS2V5LCBNaW5vcktleSwgUGxheWJhY2tOdW1UaW1lcywgVGVtcG8sIFRyYW5zcG9zaXRpb24gfSBmcm9tIFwiLi90eXBlc1wiO1xuY29uc3QgZml4ZWRFbmNvZGVVUklDb21wb25lbnQgPSAoc3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZykucmVwbGFjZSgvWyEnKCkqXS9nLCAoYykgPT4ge1xuICAgIHJldHVybiBcIiVcIiArIGMuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNik7XG4gIH0pO1xufTtcbmNvbnN0IERlY29kZWRTb25nVXJsUmVnZXg9L15pcmVhbChifGJvb2spOlxcL1xcL1tePV0rPVtePV0rPT1bXj1dKz1bQS1aXShifFxcIyk/LT89XFxkP1xcZD89MXIzNExiS2N1N1tePV0qPVtePV0qPVxcZFxcZD9cXGQ/PVxcZFxcZD9cXGQ/L1xuXG4vLyBLZXlzIHdpdGggdGhlaXIgdHJhbnNwb3NpdGlvbiBudW1iZXIgZm9yIElSZWFsXG5jb25zdCBNYWpvcktleXM6IFJlY29yZDxNYWpvcktleSwgbnVtYmVyPiA9IHtcbiAgQzogMCxcbiAgRGI6IDEsXG4gIEQ6IDIsXG4gIEViOiAzLFxuICBFOiA0LFxuICBGOiA1LFxuICBHYjogNixcbiAgRzogNyxcbiAgQWI6IDgsXG4gIEE6IDksXG4gIEJiOiAxMCxcbiAgQjogMTEsXG59O1xuT2JqZWN0LmZyZWV6ZShNYWpvcktleXMpO1xuY29uc3QgTWlub3JLZXlzOiBSZWNvcmQ8TWlub3JLZXksIG51bWJlcj4gPSB7XG4gIFwiQS1cIjogMCxcbiAgXCJCYi1cIjogMSxcbiAgXCJCLVwiOiAyLFxuICBcIkMtXCI6IDMsXG4gIFwiQyMtXCI6IDQsXG4gIFwiRC1cIjogNSxcbiAgXCJFYi1cIjogNixcbiAgXCJFLVwiOiA3LFxuICBcIkYtXCI6IDgsXG4gIFwiRiMtXCI6IDksXG4gIFwiRy1cIjogMTAsXG4gIFwiRyMtXCI6IDExLFxufTtcbk9iamVjdC5mcmVlemUoTWlub3JLZXlzKTtcblxuY29uc3QgS2V5cyA9IHsgLi4uTWFqb3JLZXlzLCAuLi5NaW5vcktleXMgfTtcbk9iamVjdC5mcmVlemUoS2V5cyk7XG5cbi8vIFRyYW5zcG9zZSBhbiBlbmNvZGVkIGlSZWFsU3RyaW5nLiBPbmx5IHdvcmtzIHdpdGggdGhlIGlyZWFsYjovLyBsaW5rcyAobmV3IGZvcm1hdClcbmV4cG9ydCBmdW5jdGlvbiB0cmFuc3Bvc2VJcmVhbFN0cmluZyhcbiAgaXJlYWxMaW5rOiBzdHJpbmcsXG4gIHRyYW5zcG9zZTogTWFqb3JLZXkgfCBNaW5vcktleVxuKSB7XG4gIGlmICghRGVjb2RlZFNvbmdVcmxSZWdleC50ZXN0KGRlY29kZVVSSUNvbXBvbmVudChpcmVhbExpbmspKSkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgcmV0dXJuIChcbiAgICAvaXJlYWxib29rLy50ZXN0KGlyZWFsTGluaylcbiAgICAgID8gZW5jb2RlSXJlYWwoZGVjb2RlSXJlYWwoaXJlYWxMaW5rKSEpXG4gICAgICA6IGlyZWFsTGlua1xuICApLnJlcGxhY2UoXG4gICAgLyg/PD1pcmVhbGJcXHcqOlxcL1xcL1tePV0qPVtePV0qPT1bXj1dKj1bXj1dKj0pKFtePV0qKT8oPz1bXj1dKj1bXj1dKj1bXj1dKj1bXj1dKj1bXj1dKikvLFxuICAgIEtleXNbdHJhbnNwb3NlXS50b1N0cmluZygpXG4gICk7XG59XG4vL2VuY29kZSBhbiBpcmVhbCBVUkwgZnJvbSBhbiBJUmVhbCBvYmplY3RcbmV4cG9ydCBmdW5jdGlvbiBlbmNvZGVJcmVhbChpcmVhbDogSVJlYWwpOiBzdHJpbmcgIHtcbiAgaWYoaXJlYWw/Lm9sZEZvcm0pcmV0dXJuIGBpcmVhbGJvb2s6Ly8ke2lyZWFsLnRpdGxlfT0ke2lyZWFsLmFydGlzdH09JHtpcmVhbC5zdHlsZX09JHtpcmVhbC5rZXl9PW49JHtpcmVhbC5jaGFuZ2VzfWBcbiAgcmV0dXJuIGBpcmVhbGI6Ly8ke2ZpeGVkRW5jb2RlVVJJQ29tcG9uZW50KFxuICAgIGlyZWFsLnRpdGxlXG4gICl9PSR7Zml4ZWRFbmNvZGVVUklDb21wb25lbnQoaXJlYWwuYXJ0aXN0KX09PSR7Zml4ZWRFbmNvZGVVUklDb21wb25lbnQoXG4gICAgaXJlYWwuc3R5bGVcbiAgKX09JHtmaXhlZEVuY29kZVVSSUNvbXBvbmVudChpcmVhbC5rZXkpfT0ke1xuICAgIGlyZWFsLnRyYW5zcG9zZVxuICB9PSR7ZW5jb2RlVVJJQ29tcG9uZW50KFwiMXIzNExiS2N1N1wiICsgaXJlYWwuY2hhbmdlcyl9PSR7ZW5jb2RlVVJJQ29tcG9uZW50KFxuICAgIGlyZWFsPy5wbGF5YmFja1N0eWxlID8/IFwiXCJcbiAgKX09JHsrKGlyZWFsPy50ZW1wbyA/PyAwKX09JHsrKGlyZWFsPy5wbGF5YmFja051bVRpbWVzID8/IDMpfVxuYDtcbn1cbi8vIGNvbnZlcnQgYSBzb25nIHN0cmluZyBpbnRvIGFuZCBJUmVhbCBvYmplY3RcbmZ1bmN0aW9uIG1ha2VJcmVhbChpcmVhbFN0cmluZzogc3RyaW5nLCBpc09sZEZvcm0/OiBib29sZWFuKSB7XG4gIGNvbnN0IGRhdGEgPSBpcmVhbFN0cmluZy5zcGxpdChcIj1cIik7XG4gIHJldHVybiBpc09sZEZvcm1cbiAgICA/IHtcbiAgICAgICAgdGl0bGU6IGRhdGFbMF0udHJpbSgpLFxuICAgICAgICBhcnRpc3Q6IGRhdGFbMV0udHJpbSgpLFxuICAgICAgICBzdHlsZTogZGF0YVszXS50cmltKCksXG4gICAgICAgIGtleTogZGF0YVs0XS50cmltKCkgYXMgS2V5LFxuICAgICAgICBjaGFuZ2VzOiBkYXRhWzVdLFxuICAgICAgICBvbGRGb3JtOnRydWVcbiAgICAgIH1cbiAgICA6IHtcbiAgICAgICAgdGl0bGU6IGRhdGFbMF0udHJpbSgpLFxuICAgICAgICBhcnRpc3Q6IGRhdGFbMV0udHJpbSgpLFxuICAgICAgICBzdHlsZTogZGF0YVszXS50cmltKCksXG4gICAgICAgIGtleTogZGF0YVs0XS50cmltKCkgYXMgS2V5LFxuICAgICAgICB0cmFuc3Bvc2U6IGRhdGFbNV0gYXMgVHJhbnNwb3NpdGlvbixcbiAgICAgICAgY2hhbmdlczogZGF0YVs2XS5zcGxpdChcIjFyMzRMYktjdTdcIilbMV0sXG4gICAgICAgIHBsYXliYWNrU3R5bGU6IGRhdGFbN10udHJpbSgpIHx8IFwiXCIsXG4gICAgICAgIHRlbXBvOiBkYXRhWzhdIGFzIFRlbXBvIHx8IFwiMFwiICxcbiAgICAgICAgcGxheWJhY2tOdW1UaW1lczogZGF0YVs5XSBhcyBQbGF5YmFja051bVRpbWVzIHx8IFwiM1wiLFxuICAgICAgfTtcbn1cbi8vIERldGVjdCBpZiBhbiBpdGVtIGlzIGEgcGxheWxpc3QgYWxsb3cgZm9yIG1heGltdW0gcGxheWxpc3RzIGxlbmd0aCBvZiAxNDAwIHNvbmdzXG5leHBvcnQgZnVuY3Rpb24gZGV0ZWN0UGxheWxpc3QobGluazogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgcGxheWxpc3QgPSAvKD88PV5pcmVhbChifGJvb2spOlxcL1xcLyhbXj1dKz1bXj1dKz09W149XSs9W0EtWl0oYnxcXCMpPy0/PVxcZD9cXGQ/PTFyMzRMYktjdTdbXj1dKj1bXj1dKj1cXGRcXGQ/XFxkPz1cXGRcXGQ/XFxkPz09PSl7MSwxNDAwfSlbXj1dKiQvLmV4ZWMoZGVjb2RlVVJJQ29tcG9uZW50KGxpbmspKTtcbiAgXG4gIHJldHVybiBwbGF5bGlzdCA/IHBsYXlsaXN0WzBdIDogdW5kZWZpbmVkO1xufVxuXG4vLyByZXR1cm4gYW4gSVJlYWwgb2JqZWN0IGlmIHRoZSBsaW5rIGlzIGEgc2luZ2xlIHNvbmcsIG9yIHVuZGVmaW5lZCBpZiBpdCdzIG5vdFxuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZUlyZWFsKGxpbms6IHN0cmluZyk6IElSZWFsIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgaXNPbGRGb3JtPS9eaXJlYWxib29rLy50ZXN0KGxpbmspXG4gIGNvbnN0IGRlY29kZWQ9ZGVjb2RlVVJJQ29tcG9uZW50KGxpbmspXG4gIGlmICghRGVjb2RlZFNvbmdVcmxSZWdleC50ZXN0KGRlY29kZWQpJiYhaXNPbGRGb3JtKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIHJldHVybiBtYWtlSXJlYWwoXG4gICAgICBkZWNvZGVkLnJlcGxhY2UoL15pcmVhbGJcXHcqOlxcL1xcLy8sIFwiXCIpLFxuICAgICAgaXNPbGRGb3JtXG4gICAgKTtcbn1cblxuXG5cbmV4cG9ydCBmdW5jdGlvbiBkZWNvZGVJcmVhbFBsYXlsaXN0KGxpbms6IHN0cmluZyk6IFByb21pc2U8SVJlYWxQbGF5bGlzdD4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIC8vY2hlY2sgZm9yIHRoZSBvbGQgZm9ybWF0XG4gICAgY29uc3QgaXNPbGRGb3JtID0gL15pcmVhbGJvb2svLnRlc3QobGluayk7XG4gICAgY29uc3QgcGxheWxpc3QgPSBkZXRlY3RQbGF5bGlzdChsaW5rKTtcbiAgICAvLyBkZWNvZGUgdGhlIFVSTCBmb3JtYXQgYW5kIHJlbW92ZSB0aGUgbGluayBwcmVmaXhcbiAgICBjb25zdCBkZWNvZGVkID0gZGVjb2RlVVJJQ29tcG9uZW50KGxpbmsucmVwbGFjZSgvXmlyZWFsYlxcdyo6XFwvXFwvLywgXCJcIikpO1xuICAgIC8vIGNoZWNrIGlmIGl0J3MgYSBwbGF5bGlzdFxuICAgIGlmIChwbGF5bGlzdCkge1xuICAgICAgY29uc3QgZGF0YSA9IC8oLiopPT09KFtePV0qKSQvLmV4ZWMoZGVjb2RlZCk7XG4gICAgICBpZiAoZGF0YSlcbiAgICAgIHtcbiAgICAgICAgY29uc3QgcmVzdWx0PXtcbiAgICAgICAgICB0aXRsZTogcGxheWxpc3QsXG4gICAgICAgICAgc29uZ3M6IGRhdGFbMV1cbiAgICAgICAgICAgIC5zcGxpdChcIj09PVwiKVxuICAgICAgICAgICAgPy5tYXAoKHNvbmcpOiBJUmVhbCA9Pm1ha2VJcmVhbChzb25nLGlzT2xkRm9ybSkpLFxuICAgICAgICB9O1xuICAgICAgICByZXN1bHQuc29uZ3MuZXZlcnkoc29uZz0+c29uZyE9PXVuZGVmaW5lZCk/cmVzb2x2ZShyZXN1bHQpOnJlamVjdCgnQ2Fubm90IHBhcnNlIHBsYXlsaXN0JylcbiAgICAgIH1cbiAgICAgIGVsc2UgcmVqZWN0KFwiQ2Fubm90IHBhcnNlIHBsYXlsaXN0XCIpO1xuICAgIH0gZWxzZSByZWplY3QoXCJJcyBub3QgYSBwbGF5bGlzdFwiKTtcbiAgfSk7XG59XG4iXX0=